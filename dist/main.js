import{D as e,_ as t,a as n,b as r,c as i,d as a,g as o,h as s,l as c,o as l,s as u,t as d,u as f,v as p,x as m}from"./logger-UCQtPvgS.js";import{a as h,c as g,d as _,i as v,l as y,n as ee,o as b,r as te,s as x,t as S,u as ne}from"./setup-BlW9NrdG.js";import{n as re,r as C,t as w}from"./state-keys-_LOm8YQj.js";import*as T from"node:path";import E from"node:process";import{spawn as ie}from"node:child_process";import*as ae from"node:os";import*as D from"node:fs/promises";var O=e(r(),1),k=e(_(),1);function A(e){switch(e){case`issue_comment`:return`issue_comment`;case`discussion`:case`discussion_comment`:return`discussion_comment`;case`workflow_dispatch`:return`workflow_dispatch`;case`issues`:return`issues`;case`pull_request`:return`pull_request`;case`pull_request_review_comment`:return`pull_request_review_comment`;case`schedule`:return`schedule`;default:return`unsupported`}}function oe(e){let t=k.context,n=A(t.eventName);return e.debug(`Parsed GitHub context`,{eventName:t.eventName,eventType:n,repo:`${t.repo.owner}/${t.repo.repo}`}),{eventName:t.eventName,eventType:n,repo:t.repo,ref:t.ref,sha:t.sha,runId:t.runId,actor:t.actor,payload:t.payload}}function j(e){return e.issue.pull_request!=null}function M(e){let{eventType:t,payload:n,repo:r}=e;if(t===`issue_comment`){let e=n;return{type:j(e)?`pr`:`issue`,number:e.issue.number,owner:r.owner,repo:r.repo}}return null}function N(e){return e.comment.author_association}function P(e){return e.comment.user.login}function F(e){return e.issue.locked}function se(e){let t=oe(e),n=`${t.repo.owner}/${t.repo.repo}`,r=M(t),i=r?.type===`issue`||r?.type===`pr`?r.type:null,a=null,o=null,s=null,c=null;if(t.eventType===`issue_comment`){let e=t.payload;a=e.comment.body,o=P(e),s=e.comment.id,c=e.issue.title}return e.info(`Collected agent context`,{eventName:t.eventName,repo:n,issueNumber:r?.number??null,issueType:i,hasComment:a!=null}),{eventName:t.eventName,repo:n,ref:t.ref,actor:t.actor,runId:String(t.runId),issueNumber:r?.number??null,issueTitle:c,issueType:i,commentBody:a,commentAuthor:o,commentId:s,defaultBranch:`main`}}var I=e(m(),1);const L=({onSseError:e,onSseEvent:t,responseTransformer:n,responseValidator:r,sseDefaultRetryDelay:i,sseMaxRetryAttempts:a,sseMaxRetryDelay:o,sseSleepFn:s,url:c,...l})=>{let u,d=s??(e=>new Promise(t=>setTimeout(t,e)));return{stream:async function*(){let s=i??3e3,f=0,p=l.signal??new AbortController().signal;for(;!p.aborted;){f++;let i=l.headers instanceof Headers?l.headers:new Headers(l.headers);u!==void 0&&i.set(`Last-Event-ID`,u);try{let e=await fetch(c,{...l,headers:i,signal:p});if(!e.ok)throw Error(`SSE failed: ${e.status} ${e.statusText}`);if(!e.body)throw Error(`No body in SSE response`);let a=e.body.pipeThrough(new TextDecoderStream).getReader(),o=``,d=()=>{try{a.cancel()}catch{}};p.addEventListener(`abort`,d);try{for(;;){let{done:e,value:i}=await a.read();if(e)break;o+=i;let c=o.split(`

`);o=c.pop()??``;for(let e of c){let i=e.split(`
`),a=[],o;for(let e of i)if(e.startsWith(`data:`))a.push(e.replace(/^data:\s*/,``));else if(e.startsWith(`event:`))o=e.replace(/^event:\s*/,``);else if(e.startsWith(`id:`))u=e.replace(/^id:\s*/,``);else if(e.startsWith(`retry:`)){let t=Number.parseInt(e.replace(/^retry:\s*/,``),10);Number.isNaN(t)||(s=t)}let c,l=!1;if(a.length){let e=a.join(`
`);try{c=JSON.parse(e),l=!0}catch{c=e}}l&&(r&&await r(c),n&&(c=await n(c))),t?.({data:c,event:o,id:u,retry:s}),a.length&&(yield c)}}}finally{p.removeEventListener(`abort`,d),a.releaseLock()}break}catch(t){if(e?.(t),a!==void 0&&f>=a)break;await d(Math.min(s*2**(f-1),o??3e4))}}}()}},R=async(e,t)=>{let n=typeof t==`function`?await t(e):t;if(n)return e.scheme===`bearer`?`Bearer ${n}`:e.scheme===`basic`?`Basic ${btoa(n)}`:n},ce={bodySerializer:e=>JSON.stringify(e,(e,t)=>typeof t==`bigint`?t.toString():t)},le=e=>{switch(e){case`label`:return`.`;case`matrix`:return`;`;case`simple`:return`,`;default:return`&`}},z=e=>{switch(e){case`form`:return`,`;case`pipeDelimited`:return`|`;case`spaceDelimited`:return`%20`;default:return`,`}},ue=e=>{switch(e){case`label`:return`.`;case`matrix`:return`;`;case`simple`:return`,`;default:return`&`}},B=({allowReserved:e,explode:t,name:n,style:r,value:i})=>{if(!t){let t=(e?i:i.map(e=>encodeURIComponent(e))).join(z(r));switch(r){case`label`:return`.${t}`;case`matrix`:return`;${n}=${t}`;case`simple`:return t;default:return`${n}=${t}`}}let a=le(r),o=i.map(t=>r===`label`||r===`simple`?e?t:encodeURIComponent(t):V({allowReserved:e,name:n,value:t})).join(a);return r===`label`||r===`matrix`?a+o:o},V=({allowReserved:e,name:t,value:n})=>{if(n==null)return``;if(typeof n==`object`)throw Error("Deeply-nested arrays/objects arenâ€™t supported. Provide your own `querySerializer()` to handle these.");return`${t}=${e?n:encodeURIComponent(n)}`},de=({allowReserved:e,explode:t,name:n,style:r,value:i,valueOnly:a})=>{if(i instanceof Date)return a?i.toISOString():`${n}=${i.toISOString()}`;if(r!==`deepObject`&&!t){let t=[];Object.entries(i).forEach(([n,r])=>{t=[...t,n,e?r:encodeURIComponent(r)]});let a=t.join(`,`);switch(r){case`form`:return`${n}=${a}`;case`label`:return`.${a}`;case`matrix`:return`;${n}=${a}`;default:return a}}let o=ue(r),s=Object.entries(i).map(([t,i])=>V({allowReserved:e,name:r===`deepObject`?`${n}[${t}]`:t,value:i})).join(o);return r===`label`||r===`matrix`?o+s:s},fe=/\{[^{}]+\}/g,pe=({path:e,url:t})=>{let n=t,r=t.match(fe);if(r)for(let t of r){let r=!1,i=t.substring(1,t.length-1),a=`simple`;i.endsWith(`*`)&&(r=!0,i=i.substring(0,i.length-1)),i.startsWith(`.`)?(i=i.substring(1),a=`label`):i.startsWith(`;`)&&(i=i.substring(1),a=`matrix`);let o=e[i];if(o==null)continue;if(Array.isArray(o)){n=n.replace(t,B({explode:r,name:i,style:a,value:o}));continue}if(typeof o==`object`){n=n.replace(t,de({explode:r,name:i,style:a,value:o,valueOnly:!0}));continue}if(a===`matrix`){n=n.replace(t,`;${V({name:i,value:o})}`);continue}let s=encodeURIComponent(a===`label`?`.${o}`:o);n=n.replace(t,s)}return n},me=({baseUrl:e,path:t,query:n,querySerializer:r,url:i})=>{let a=i.startsWith(`/`)?i:`/${i}`,o=(e??``)+a;t&&(o=pe({path:t,url:o}));let s=n?r(n):``;return s.startsWith(`?`)&&(s=s.substring(1)),s&&(o+=`?${s}`),o},he=({allowReserved:e,array:t,object:n}={})=>r=>{let i=[];if(r&&typeof r==`object`)for(let a in r){let o=r[a];if(o!=null)if(Array.isArray(o)){let n=B({allowReserved:e,explode:!0,name:a,style:`form`,value:o,...t});n&&i.push(n)}else if(typeof o==`object`){let t=de({allowReserved:e,explode:!0,name:a,style:`deepObject`,value:o,...n});t&&i.push(t)}else{let t=V({allowReserved:e,name:a,value:o});t&&i.push(t)}}return i.join(`&`)},ge=e=>{if(!e)return`stream`;let t=e.split(`;`)[0]?.trim();if(t){if(t.startsWith(`application/json`)||t.endsWith(`+json`))return`json`;if(t===`multipart/form-data`)return`formData`;if([`application/`,`audio/`,`image/`,`video/`].some(e=>t.startsWith(e)))return`blob`;if(t.startsWith(`text/`))return`text`}},_e=(e,t)=>t?!!(e.headers.has(t)||e.query?.[t]||e.headers.get(`Cookie`)?.includes(`${t}=`)):!1,ve=async({security:e,...t})=>{for(let n of e){if(_e(t,n.name))continue;let e=await R(n,t.auth);if(!e)continue;let r=n.name??`Authorization`;switch(n.in){case`query`:t.query||={},t.query[r]=e;break;case`cookie`:t.headers.append(`Cookie`,`${r}=${e}`);break;case`header`:default:t.headers.set(r,e);break}}},ye=e=>me({baseUrl:e.baseUrl,path:e.path,query:e.query,querySerializer:typeof e.querySerializer==`function`?e.querySerializer:he(e.querySerializer),url:e.url}),be=(e,t)=>{let n={...e,...t};return n.baseUrl?.endsWith(`/`)&&(n.baseUrl=n.baseUrl.substring(0,n.baseUrl.length-1)),n.headers=xe(e.headers,t.headers),n},xe=(...e)=>{let t=new Headers;for(let n of e){if(!n||typeof n!=`object`)continue;let e=n instanceof Headers?n.entries():Object.entries(n);for(let[n,r]of e)if(r===null)t.delete(n);else if(Array.isArray(r))for(let e of r)t.append(n,e);else r!==void 0&&t.set(n,typeof r==`object`?JSON.stringify(r):r)}return t};var H=class{_fns;constructor(){this._fns=[]}clear(){this._fns=[]}getInterceptorIndex(e){return typeof e==`number`?this._fns[e]?e:-1:this._fns.indexOf(e)}exists(e){let t=this.getInterceptorIndex(e);return!!this._fns[t]}eject(e){let t=this.getInterceptorIndex(e);this._fns[t]&&(this._fns[t]=null)}update(e,t){let n=this.getInterceptorIndex(e);return this._fns[n]?(this._fns[n]=t,e):!1}use(e){return this._fns=[...this._fns,e],this._fns.length-1}};const Se=()=>({error:new H,request:new H,response:new H}),Ce=he({allowReserved:!1,array:{explode:!0,style:`form`},object:{explode:!0,style:`deepObject`}}),we={"Content-Type":`application/json`},Te=(e={})=>({...ce,headers:we,parseAs:`auto`,querySerializer:Ce,...e}),Ee=(e={})=>{let t=be(Te(),e),n=()=>({...t}),r=e=>(t=be(t,e),n()),i=Se(),a=async e=>{let n={...t,...e,fetch:e.fetch??t.fetch??globalThis.fetch,headers:xe(t.headers,e.headers),serializedBody:void 0};return n.security&&await ve({...n,security:n.security}),n.requestValidator&&await n.requestValidator(n),n.body&&n.bodySerializer&&(n.serializedBody=n.bodySerializer(n.body)),(n.serializedBody===void 0||n.serializedBody===``)&&n.headers.delete(`Content-Type`),{opts:n,url:ye(n)}},o=async e=>{let{opts:t,url:n}=await a(e),r={redirect:`follow`,...t,body:t.serializedBody},o=new Request(n,r);for(let e of i.request._fns)e&&(o=await e(o,t));let s=t.fetch,c=await s(o);for(let e of i.response._fns)e&&(c=await e(c,o,t));let l={request:o,response:c};if(c.ok){if(c.status===204||c.headers.get(`Content-Length`)===`0`)return t.responseStyle===`data`?{}:{data:{},...l};let e=(t.parseAs===`auto`?ge(c.headers.get(`Content-Type`)):t.parseAs)??`json`,n;switch(e){case`arrayBuffer`:case`blob`:case`formData`:case`json`:case`text`:n=await c[e]();break;case`stream`:return t.responseStyle===`data`?c.body:{data:c.body,...l}}return e===`json`&&(t.responseValidator&&await t.responseValidator(n),t.responseTransformer&&(n=await t.responseTransformer(n))),t.responseStyle===`data`?n:{data:n,...l}}let u=await c.text(),d;try{d=JSON.parse(u)}catch{}let f=d??u,p=f;for(let e of i.error._fns)e&&(p=await e(f,c,o,t));if(p||={},t.throwOnError)throw p;return t.responseStyle===`data`?void 0:{error:p,...l}},s=e=>{let t=t=>o({...t,method:e});return t.sse=async t=>{let{opts:n,url:r}=await a(t);return L({...n,body:n.body,headers:n.headers,method:e,url:r})},t};return{buildUrl:ye,connect:s(`CONNECT`),delete:s(`DELETE`),get:s(`GET`),getConfig:n,head:s(`HEAD`),interceptors:i,options:s(`OPTIONS`),patch:s(`PATCH`),post:s(`POST`),put:s(`PUT`),request:o,setConfig:r,trace:s(`TRACE`)}};Object.entries({$body_:`body`,$headers_:`headers`,$path_:`path`,$query_:`query`});const De=Ee(Te({baseUrl:`http://localhost:4096`}));var U=class{_client=De;constructor(e){e?.client&&(this._client=e.client)}},Oe=class extends U{event(e){return(e?.client??this._client).get.sse({url:`/global/event`,...e})}},ke=class extends U{list(e){return(e?.client??this._client).get({url:`/project`,...e})}current(e){return(e?.client??this._client).get({url:`/project/current`,...e})}},Ae=class extends U{list(e){return(e?.client??this._client).get({url:`/pty`,...e})}create(e){return(e?.client??this._client).post({url:`/pty`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}remove(e){return(e.client??this._client).delete({url:`/pty/{id}`,...e})}get(e){return(e.client??this._client).get({url:`/pty/{id}`,...e})}update(e){return(e.client??this._client).put({url:`/pty/{id}`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}connect(e){return(e.client??this._client).get({url:`/pty/{id}/connect`,...e})}},je=class extends U{get(e){return(e?.client??this._client).get({url:`/config`,...e})}update(e){return(e?.client??this._client).patch({url:`/config`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}providers(e){return(e?.client??this._client).get({url:`/config/providers`,...e})}},Me=class extends U{ids(e){return(e?.client??this._client).get({url:`/experimental/tool/ids`,...e})}list(e){return(e.client??this._client).get({url:`/experimental/tool`,...e})}},Ne=class extends U{dispose(e){return(e?.client??this._client).post({url:`/instance/dispose`,...e})}},Pe=class extends U{get(e){return(e?.client??this._client).get({url:`/path`,...e})}},Fe=class extends U{get(e){return(e?.client??this._client).get({url:`/vcs`,...e})}},Ie=class extends U{list(e){return(e?.client??this._client).get({url:`/session`,...e})}create(e){return(e?.client??this._client).post({url:`/session`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}status(e){return(e?.client??this._client).get({url:`/session/status`,...e})}delete(e){return(e.client??this._client).delete({url:`/session/{id}`,...e})}get(e){return(e.client??this._client).get({url:`/session/{id}`,...e})}update(e){return(e.client??this._client).patch({url:`/session/{id}`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}children(e){return(e.client??this._client).get({url:`/session/{id}/children`,...e})}todo(e){return(e.client??this._client).get({url:`/session/{id}/todo`,...e})}init(e){return(e.client??this._client).post({url:`/session/{id}/init`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}fork(e){return(e.client??this._client).post({url:`/session/{id}/fork`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}abort(e){return(e.client??this._client).post({url:`/session/{id}/abort`,...e})}unshare(e){return(e.client??this._client).delete({url:`/session/{id}/share`,...e})}share(e){return(e.client??this._client).post({url:`/session/{id}/share`,...e})}diff(e){return(e.client??this._client).get({url:`/session/{id}/diff`,...e})}summarize(e){return(e.client??this._client).post({url:`/session/{id}/summarize`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}messages(e){return(e.client??this._client).get({url:`/session/{id}/message`,...e})}prompt(e){return(e.client??this._client).post({url:`/session/{id}/message`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}message(e){return(e.client??this._client).get({url:`/session/{id}/message/{messageID}`,...e})}promptAsync(e){return(e.client??this._client).post({url:`/session/{id}/prompt_async`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}command(e){return(e.client??this._client).post({url:`/session/{id}/command`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}shell(e){return(e.client??this._client).post({url:`/session/{id}/shell`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}revert(e){return(e.client??this._client).post({url:`/session/{id}/revert`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}unrevert(e){return(e.client??this._client).post({url:`/session/{id}/unrevert`,...e})}},Le=class extends U{list(e){return(e?.client??this._client).get({url:`/command`,...e})}},Re=class extends U{authorize(e){return(e.client??this._client).post({url:`/provider/{id}/oauth/authorize`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}callback(e){return(e.client??this._client).post({url:`/provider/{id}/oauth/callback`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}},ze=class extends U{list(e){return(e?.client??this._client).get({url:`/provider`,...e})}auth(e){return(e?.client??this._client).get({url:`/provider/auth`,...e})}oauth=new Re({client:this._client})},Be=class extends U{text(e){return(e.client??this._client).get({url:`/find`,...e})}files(e){return(e.client??this._client).get({url:`/find/file`,...e})}symbols(e){return(e.client??this._client).get({url:`/find/symbol`,...e})}},Ve=class extends U{list(e){return(e.client??this._client).get({url:`/file`,...e})}read(e){return(e.client??this._client).get({url:`/file/content`,...e})}status(e){return(e?.client??this._client).get({url:`/file/status`,...e})}},He=class extends U{log(e){return(e?.client??this._client).post({url:`/log`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}agents(e){return(e?.client??this._client).get({url:`/agent`,...e})}},Ue=class extends U{remove(e){return(e.client??this._client).delete({url:`/mcp/{name}/auth`,...e})}start(e){return(e.client??this._client).post({url:`/mcp/{name}/auth`,...e})}callback(e){return(e.client??this._client).post({url:`/mcp/{name}/auth/callback`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}authenticate(e){return(e.client??this._client).post({url:`/mcp/{name}/auth/authenticate`,...e})}set(e){return(e.client??this._client).put({url:`/auth/{id}`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}},We=class extends U{status(e){return(e?.client??this._client).get({url:`/mcp`,...e})}add(e){return(e?.client??this._client).post({url:`/mcp`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}connect(e){return(e.client??this._client).post({url:`/mcp/{name}/connect`,...e})}disconnect(e){return(e.client??this._client).post({url:`/mcp/{name}/disconnect`,...e})}auth=new Ue({client:this._client})},Ge=class extends U{status(e){return(e?.client??this._client).get({url:`/lsp`,...e})}},Ke=class extends U{status(e){return(e?.client??this._client).get({url:`/formatter`,...e})}},qe=class extends U{next(e){return(e?.client??this._client).get({url:`/tui/control/next`,...e})}response(e){return(e?.client??this._client).post({url:`/tui/control/response`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}},Je=class extends U{appendPrompt(e){return(e?.client??this._client).post({url:`/tui/append-prompt`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}openHelp(e){return(e?.client??this._client).post({url:`/tui/open-help`,...e})}openSessions(e){return(e?.client??this._client).post({url:`/tui/open-sessions`,...e})}openThemes(e){return(e?.client??this._client).post({url:`/tui/open-themes`,...e})}openModels(e){return(e?.client??this._client).post({url:`/tui/open-models`,...e})}submitPrompt(e){return(e?.client??this._client).post({url:`/tui/submit-prompt`,...e})}clearPrompt(e){return(e?.client??this._client).post({url:`/tui/clear-prompt`,...e})}executeCommand(e){return(e?.client??this._client).post({url:`/tui/execute-command`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}showToast(e){return(e?.client??this._client).post({url:`/tui/show-toast`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}publish(e){return(e?.client??this._client).post({url:`/tui/publish`,...e,headers:{"Content-Type":`application/json`,...e?.headers}})}control=new qe({client:this._client})},Ye=class extends U{subscribe(e){return(e?.client??this._client).get.sse({url:`/event`,...e})}},Xe=class extends U{postSessionIdPermissionsPermissionId(e){return(e.client??this._client).post({url:`/session/{id}/permissions/{permissionID}`,...e,headers:{"Content-Type":`application/json`,...e.headers}})}global=new Oe({client:this._client});project=new ke({client:this._client});pty=new Ae({client:this._client});config=new je({client:this._client});tool=new Me({client:this._client});instance=new Ne({client:this._client});path=new Pe({client:this._client});vcs=new Fe({client:this._client});session=new Ie({client:this._client});command=new Le({client:this._client});provider=new ze({client:this._client});find=new Be({client:this._client});file=new Ve({client:this._client});app=new He({client:this._client});mcp=new We({client:this._client});lsp=new Ge({client:this._client});formatter=new Ke({client:this._client});tui=new Je({client:this._client});auth=new Ue({client:this._client});event=new Ye({client:this._client})};function Ze(e){if(!e?.fetch){let t=e=>(e.timeout=!1,fetch(e));e={...e,fetch:t}}return e?.directory&&(e.headers={...e.headers,"x-opencode-directory":e.directory}),new Xe({client:Ee(e)})}async function Qe(e){e=Object.assign({hostname:`127.0.0.1`,port:4096,timeout:5e3},e??{});let t=[`serve`,`--hostname=${e.hostname}`,`--port=${e.port}`];e.config?.logLevel&&t.push(`--log-level=${e.config.logLevel}`);let n=ie(`opencode`,t,{signal:e.signal,env:{...process.env,OPENCODE_CONFIG_CONTENT:JSON.stringify(e.config??{})}});return{url:await new Promise((t,r)=>{let i=setTimeout(()=>{r(Error(`Timeout waiting for server to start after ${e.timeout}ms`))},e.timeout),a=``;n.stdout?.on(`data`,e=>{a+=e.toString();let n=a.split(`
`);for(let e of n)if(e.startsWith(`opencode server listening`)){let n=e.match(/on\s+(https?:\/\/[^\s]+)/);if(!n)throw Error(`Failed to parse server url from output: ${e}`);clearTimeout(i),t(n[1]);return}}),n.stderr?.on(`data`,e=>{a+=e.toString()}),n.on(`exit`,e=>{clearTimeout(i);let t=`Server exited with code ${e}`;a.trim()&&(t+=`\nServer output: ${a}`),r(Error(t))}),n.on(`error`,e=>{clearTimeout(i),r(e)}),e.signal&&e.signal.addEventListener(`abort`,()=>{clearTimeout(i),r(Error(`Aborted`))})}),close(){n.kill()}}}async function $e(e){let t=await Qe({...e});return{client:Ze({baseUrl:t.url}),server:t}}function et(e){if(typeof e==`object`&&e&&`action`in e){let t=e.action;return typeof t==`string`?t:``}return``}function tt(e,t){let n=et(e.raw.payload);switch(e.eventType){case`issue_comment`:return{directive:`Respond to the comment above.`,appendMode:!0};case`discussion_comment`:return{directive:`Respond to the discussion comment above.`,appendMode:!0};case`issues`:return n===`opened`?{directive:`Triage this issue: summarize, reproduce if possible, propose next steps.`,appendMode:!0}:{directive:`Respond to the mention in this issue.`,appendMode:!0};case`pull_request`:return{directive:`Review this pull request for code quality, potential bugs, and improvements.`,appendMode:!0};case`pull_request_review_comment`:return{directive:nt(e),appendMode:!0};case`schedule`:case`workflow_dispatch`:return{directive:t??``,appendMode:!1};case`unsupported`:default:return{directive:`Execute the requested operation.`,appendMode:!0}}}function nt(e){let t=e.target,n=[`Respond to the review comment.`,``];return t?.path!=null&&n.push(`**File:** \`${t.path}\``),t?.line!=null&&n.push(`**Line:** ${t.line}`),t?.commitId!=null&&n.push(`**Commit:** \`${t.commitId}\``),t?.diffHunk!=null&&t.diffHunk.length>0&&n.push(``,`**Diff Context:**`,"```diff",t.diffHunk,"```"),n.join(`
`)}function rt(e,t){let{directive:n,appendMode:r}=tt(e,t),i=[`## Task`,``];return r?(i.push(n),t!=null&&t.trim().length>0&&i.push(``,`**Additional Instructions:**`,t.trim())):i.push(n),i.push(``),i.join(`
`)}function it(e,t){let{context:n,customPrompt:r,cacheStatus:i,sessionContext:a}=e,o=[];if(o.push(`# Agent Context

You are the Fro Bot Agent running in GitHub Actions.

## Environment
- **Repository:** ${n.repo}
- **Branch/Ref:** ${n.ref}
- **Event:** ${n.eventName}
- **Actor:** ${n.actor}
- **Run ID:** ${n.runId}
- **Cache Status:** ${i}
`),n.issueNumber!=null){let e=n.issueType===`pr`?`Pull Request`:`Issue`;o.push(`## ${e} Context
- **Number:** #${n.issueNumber}
- **Title:** ${n.issueTitle??`N/A`}
- **Type:** ${n.issueType??`unknown`}
`)}n.commentBody!=null&&o.push(`## Trigger Comment
**Author:** ${n.commentAuthor??`unknown`}

\`\`\`
${n.commentBody}
\`\`\`
`),a!=null&&o.push(at(a)),o.push(`## Session Management (REQUIRED)

Before investigating any issue:
1. Use \`session_search\` to find relevant prior sessions for this repository
2. Use \`session_read\` to review prior work if found
3. Avoid repeating investigation already completed in previous sessions

Before completing:
1. Ensure your session contains a summary of work done
2. Include key decisions, findings, and outcomes
3. This summary will be searchable in future agent runs
`);let s=n.issueNumber??`<number>`;o.push(`## GitHub Operations (Use gh CLI)

The \`gh\` CLI is pre-authenticated. Use it for all GitHub operations:

### Commenting
\`\`\`bash
# Comment on issue
gh issue comment ${s} --body "Your message"

# Comment on PR
gh pr comment ${s} --body "Your message"
\`\`\`

### Creating PRs
\`\`\`bash
# Create a new PR
gh pr create --title "feat(scope): description" --body "Details..." --base ${n.defaultBranch} --head feature-branch
\`\`\`

### Pushing Commits
\`\`\`bash
# Commit and push changes
git add .
git commit -m "type(scope): description"
git push origin HEAD
\`\`\`

### API Calls
\`\`\`bash
# Query the GitHub API
gh api repos/${n.repo}/issues --jq '.[].title'
gh api repos/${n.repo}/pulls/${s}/files --jq '.[].filename'
\`\`\`
`),o.push(`## Run Summary (REQUIRED)

Every comment you post MUST include a collapsed details block at the end:

\`\`\`markdown
<details>
<summary>Run Summary</summary>

| Field | Value |
|-------|-------|
| Event | ${n.eventName} |
| Repository | ${n.repo} |
| Run ID | ${n.runId} |
| Cache | ${i} |
| Session | ${e.sessionId??`<your_session_id>`} |

</details>
\`\`\`
`),r!=null&&r.trim().length>0&&e.triggerContext==null&&o.push(`## Custom Instructions

${r.trim()}
`),e.triggerContext==null?n.commentBody==null?o.push(`## Task

Execute the requested operation for repository ${n.repo}. Follow all instructions and requirements listed in this prompt.
`):o.push(`## Task

Respond to the trigger comment above. Follow all instructions and requirements listed in this prompt.
`):o.push(rt(e.triggerContext,r));let c=o.join(`
`);return t.debug(`Built agent prompt`,{length:c.length,hasCustom:r!=null,hasSessionContext:a!=null}),c}function at(e){let t=[`## Prior Session Context`];if(e.recentSessions.length>0){t.push(``),t.push(`### Recent Sessions`),t.push(`| ID | Title | Updated | Messages | Agents |`),t.push(`|----|-------|---------|----------|--------|`);for(let n of e.recentSessions.slice(0,5)){let e=new Date(n.updatedAt).toISOString().split(`T`)[0],r=n.agents.join(`, `)||`N/A`,i=n.title||`Untitled`;t.push(`| ${n.id} | ${i} | ${e} | ${n.messageCount} | ${r} |`)}t.push(``),t.push("Use `session_read` to review any of these sessions in detail.")}if(e.priorWorkContext.length>0){t.push(``),t.push(`### Relevant Prior Work`),t.push(``),t.push(`The following sessions contain content related to this issue:`),t.push(``);for(let n of e.priorWorkContext.slice(0,3)){t.push(`**Session ${n.sessionId}:**`);for(let e of n.matches.slice(0,2))t.push(`- ${e.excerpt}`);t.push(``)}t.push("Use `session_read` to review full context before starting new investigation.")}return t.push(``),t.join(`
`)}const ot={todowrite:[`Todo`,`\x1B[33m\x1B[1m`],todoread:[`Todo`,`\x1B[33m\x1B[1m`],bash:[`Bash`,`\x1B[31m\x1B[1m`],edit:[`Edit`,`\x1B[32m\x1B[1m`],glob:[`Glob`,`\x1B[34m\x1B[1m`],grep:[`Grep`,`\x1B[34m\x1B[1m`],list:[`List`,`\x1B[34m\x1B[1m`],read:[`Read`,`\x1B[35m\x1B[1m`],write:[`Write`,`\x1B[32m\x1B[1m`],websearch:[`Search`,`\x1B[2m\x1B[1m`]},st=`\x1B[0m`;function ct(e,t){let[n,r]=ot[e.toLowerCase()]??[e,`\x1B[36m\x1B[1m`],i=n.padEnd(7,` `);E.stdout.write(`\n${r}|${st}[0m[2m ${i} ${st}${t}\n`)}function lt(e){E.stdout.write(`\n${e}\n`)}async function ut(e,t,n){let r=``;for await(let i of e){let e=i.properties;if(i.type===`message.part.updated`){let n=e.part;if(n?.sessionID!==t)continue;if(n.type===`text`&&typeof n.text==`string`){r=n.text;let e=n.time?.end;e!=null&&Number.isFinite(e)&&(lt(r),r=``)}else if(n.type===`tool`&&n.state?.status===`completed`){let e=n.tool??`unknown`,t=n.state.input??{};ct(e,n.state.title??(Object.keys(t).length>0?JSON.stringify(t):`Unknown`))}}else i.type===`session.error`&&e.sessionID===t&&n.error(`Session error`,{error:e.error})}}async function dt(e,t,n){let r=Date.now(),i=new AbortController,a=n?.timeoutMs??p,o=null,s=!1,c=null;a>0&&(o=setTimeout(()=>{s=!0,t.warning(`Execution timeout reached`,{timeoutMs:a}),i.abort()},a)),t.info(`Executing OpenCode agent (SDK mode)`,{agent:n?.agent??`Sisyphus`,hasModelOverride:n?.model!=null,timeoutMs:a});try{let o=await $e({signal:i.signal}),{client:l}=o;c=o.server,t.debug(`OpenCode server started`,{url:c.url});let u=await l.session.create();if(u.data==null||u.error!=null){let e=u.error==null?`No data returned`:String(u.error);throw Error(`Failed to create session: ${e}`)}let d=u.data.id;t.debug(`Session created`,{sessionId:d});let f=it({...e,sessionId:d},t),p=n?.agent??`Sisyphus`;t.debug(`Using agent`,{agent:p});let m=await l.event.subscribe(),h=!1,g=ut(m.stream,d,t).catch(e=>{e instanceof Error&&e.name!==`AbortError`&&t.debug(`Event stream error`,{error:e.message})}).finally(()=>{h=!0}),_={agent:p,parts:[{type:`text`,text:f}]};n?.model!=null&&(_.model={providerID:n.model.providerID,modelID:n.model.modelID}),t.debug(`Sending prompt to OpenCode`,{sessionId:d,body:_});let v=await l.session.prompt({path:{id:d},body:_});if(!h){let e=new Promise(e=>setTimeout(e,1e3));await Promise.race([g,e])}if(s)return{success:!1,exitCode:130,duration:Date.now()-r,sessionId:d,error:`Execution timed out after ${a}ms`};if(v.error!=null)return t.error(`OpenCode prompt failed`,{error:String(v.error)}),{success:!1,exitCode:1,duration:Date.now()-r,sessionId:d,error:String(v.error)};let y=Date.now()-r;return t.info(`OpenCode execution completed`,{sessionId:d,durationMs:y}),{success:!0,exitCode:0,duration:y,sessionId:d,error:null}}catch(e){let n=Date.now()-r,i=e instanceof Error?e.message:String(e);return t.error(`OpenCode execution failed`,{error:i,durationMs:n}),{success:!1,exitCode:1,duration:n,sessionId:null,error:i}}finally{o!=null&&clearTimeout(o),i.abort(),c?.close()}}async function ft(e,t){let n=e??`opencode`;try{let e=``;await I.exec(n,[`--version`],{listeners:{stdout:t=>{e+=t.toString()}},silent:!0});let r=/(\d+\.\d+\.\d+)/.exec(e)?.[1]??null;return t.debug(`OpenCode version verified`,{version:r}),{available:!0,version:r}}catch{return t.warning(`OpenCode not available`),{available:!1,version:null}}}async function pt(e){let{logger:t,opencodeVersion:n}=e,r=E.env.OPENCODE_PATH??null,i=await ft(r,t);if(i.available&&i.version!=null)return t.info(`OpenCode already available`,{version:i.version}),{path:r??`opencode`,version:i.version,didSetup:!1};t.info(`OpenCode not found, running auto-setup`,{requestedVersion:n});let a=await S();if(a==null)throw Error(`Auto-setup failed: runSetup returned null`);return O.addPath(a.opencodePath),E.env.OPENCODE_PATH=a.opencodePath,t.info(`Auto-setup completed`,{version:a.opencodeVersion,path:a.opencodePath}),{path:a.opencodePath,version:a.opencodeVersion,didSetup:!0}}const W=`agent: working`;async function mt(e,t,n){return t.commentId==null?(n.debug(`No comment ID, skipping eyes reaction`),!1):await h(e,t.repo,t.commentId,`eyes`,n)==null?!1:(n.info(`Added eyes reaction`,{commentId:t.commentId}),!0)}async function ht(e,t,n){return t.issueNumber==null?(n.debug(`No issue number, skipping working label`),!1):await x(e,t.repo,W,`fcf2e1`,`Agent is currently working on this`,n)&&await v(e,t.repo,t.issueNumber,[W],n)?(n.info(`Added working label`,{issueNumber:t.issueNumber}),!0):!1}async function gt(e,t,n){await Promise.all([mt(e,t,n),ht(e,t,n)])}async function _t(e,t,n){if(t.commentId==null||t.botLogin==null)return;let r=(await y(e,t.repo,t.commentId,n)).find(e=>e.content===`eyes`&&e.userLogin===t.botLogin);r!=null&&await b(e,t.repo,t.commentId,r.id,n)}async function vt(e,t,n,r){t.commentId!=null&&await h(e,t.repo,t.commentId,n,r)}async function yt(e,t,n){if(t.commentId==null||t.botLogin==null){n.debug(`Missing comment ID or bot login, skipping reaction update`);return}try{await _t(e,t,n),await vt(e,t,`hooray`,n),n.info(`Updated reaction to success indicator`,{commentId:t.commentId,reaction:`hooray`})}catch(e){n.warning(`Failed to update reaction (non-fatal)`,{error:e instanceof Error?e.message:String(e)})}}async function bt(e,t,n){if(t.commentId==null||t.botLogin==null){n.debug(`Missing comment ID or bot login, skipping reaction update`);return}try{await _t(e,t,n),await vt(e,t,`confused`,n),n.info(`Updated reaction to confused`,{commentId:t.commentId})}catch(e){n.warning(`Failed to update failure reaction (non-fatal)`,{error:e instanceof Error?e.message:String(e)})}}async function xt(e,t,n){if(t.issueNumber==null){n.debug(`No issue number, skipping label removal`);return}await ne(e,t.repo,t.issueNumber,W,n)&&n.info(`Removed working label`,{issueNumber:t.issueNumber})}async function St(e,t,n,r){n?await yt(e,t,r):await bt(e,t,r),await xt(e,t,r)}function Ct(e,t){try{JSON.parse(e)}catch{throw Error(`${t} must be valid JSON`)}}function wt(e,t){let n=e.trim();if(!/^\d+$/.test(n))throw Error(`${t} must be a positive integer, received: ${e}`);let r=Number.parseInt(n,10);if(r===0)throw Error(`${t} must be a positive integer, received: ${e}`);return r}function Tt(e){return{success:!0,data:e}}function G(e){return{success:!1,error:e}}function Et(e){let t=e.trim(),n=t.indexOf(`/`);if(n===-1)throw Error(`Invalid model format: "${e}". Expected "provider/model" (e.g., "anthropic/claude-sonnet-4-20250514")`);let r=t.slice(0,n).trim(),i=t.slice(n+1).trim();if(r.length===0)throw Error(`Invalid model format: "${e}". Provider cannot be empty.`);if(i.length===0)throw Error(`Invalid model format: "${e}". Model ID cannot be empty.`);return{providerID:r,modelID:i}}function Dt(e){let t=e.trim();if(!/^\d+$/.test(t))throw Error(`timeout must be a non-negative integer, received: ${e}`);let n=Number.parseInt(t,10);if(Number.isNaN(n)||n<0)throw Error(`timeout must be a non-negative integer, received: ${e}`);return n}function Ot(){try{let e=O.getInput(`github-token`,{required:!0}).trim();if(e.length===0)return G(Error(`github-token is required but was not provided`));let n=O.getInput(`auth-json`,{required:!0}).trim();if(n.length===0)return G(Error(`auth-json is required but was not provided`));Ct(n,`auth-json`);let r=O.getInput(`prompt`).trim(),i=r.length>0?r:null,a=O.getInput(`session-retention`).trim(),c=a.length>0?wt(a,`session-retention`):t,l=O.getInput(`s3-backup`).trim().toLowerCase()===`true`,u=O.getInput(`s3-bucket`).trim(),d=u.length>0?u:null,f=O.getInput(`aws-region`).trim(),m=f.length>0?f:null,h=O.getInput(`agent`).trim(),g=h.length>0?h:s,_=O.getInput(`model`).trim(),v=_.length>0?Et(_):null,y=O.getInput(`timeout`).trim(),ee=y.length>0?Dt(y):p,b=O.getInput(`opencode-version`).trim();return Tt({githubToken:e,authJson:n,prompt:i,sessionRetention:c,s3Backup:l,s3Bucket:d,awsRegion:m,agent:g,model:v,timeoutMs:ee,opencodeVersion:b.length>0?b:o,skipCache:O.getInput(`skip-cache`).trim().toLowerCase()===`true`})}catch(e){return G(e instanceof Error?e:Error(String(e)))}}function K(e){O.setOutput(`session-id`,e.sessionId??``),O.setOutput(`cache-status`,e.cacheStatus),O.setOutput(`duration`,e.duration)}function q(){let e=E.env.XDG_DATA_HOME??T.join(ae.homedir(),`.local`,`share`);return T.join(e,`opencode`,`storage`)}async function kt(e){try{let t=await D.readFile(e,`utf8`);return JSON.parse(t)}catch{return null}}async function J(e){try{let t=await D.readdir(e,{withFileTypes:!0}),n=[];for(let r of t)if(r.isFile()&&r.name.endsWith(`.json`)){let t=await kt(T.join(e,r.name));t!=null&&n.push(t)}return n}catch{return[]}}async function At(e){let t=q(),n=T.join(t,`project`);return e.debug(`Listing projects`,{projectDir:n}),J(n)}async function jt(e,t){let n=await At(t);for(let t of n)if(t.worktree===e)return t;return null}async function Y(e,t){let n=q(),r=T.join(n,`session`,e);return t.debug(`Listing sessions for project`,{projectID:e,sessionDir:r}),J(r)}async function X(e,t){let n=q(),r=T.join(n,`message`,e);return t.debug(`Reading session messages`,{sessionID:e,messageDir:r}),[...await J(r)].sort((e,t)=>e.time.created-t.time.created)}async function Mt(e,t){let n=q(),r=T.join(n,`part`,e);return t.debug(`Reading message parts`,{messageID:e,partDir:r}),J(r)}async function Nt(e){try{let t=await D.stat(e);return await D.unlink(e),t.size}catch{return 0}}async function Pt(e){let t=0;try{let n=await D.readdir(e,{withFileTypes:!0});for(let r of n){let n=T.join(e,r.name);if(r.isDirectory())t+=await Pt(n);else{let e=await D.stat(n);t+=e.size}}await D.rm(e,{recursive:!0,force:!0})}catch{}return t}async function Ft(e,t,n){let r=q(),i=0,a=await X(t,n);for(let e of a){let t=T.join(r,`part`,e.id);i+=await Pt(t)}let o=T.join(r,`message`,t);i+=await Pt(o);let s=T.join(r,`session`,e,`${t}.json`);i+=await Nt(s);let c=T.join(r,`todo`,`${t}.json`);i+=await Nt(c);let l=T.join(r,`session_diff`,`${t}.json`);return i+=await Nt(l),n.debug(`Deleted session`,{sessionID:t,freedBytes:i}),i}async function It(e,t){let n=await At(t),r=null;for(let i of n){let n=await Y(i.id,t);for(let t of n)t.time.created<=e||(r==null||t.time.created>r.session.time.created)&&(r={projectID:i.id,session:t})}return r!=null&&t.debug(`Found latest session`,{sessionId:r.session.id,projectId:r.projectID,createdAt:r.session.time.created}),r}const Lt={maxSessions:50,maxAgeDays:30};async function Rt(e,t,n){let{maxSessions:r,maxAgeDays:i}=t;n.info(`Starting session pruning`,{directory:e,maxSessions:r,maxAgeDays:i});let a=await jt(e,n);if(a==null)return n.debug(`No project found for pruning`,{directory:e}),{prunedCount:0,prunedSessionIds:[],remainingCount:0,freedBytes:0};let o=await Y(a.id,n),s=o.filter(e=>e.parentID==null);if(s.length===0)return{prunedCount:0,prunedSessionIds:[],remainingCount:0,freedBytes:0};let c=[...s].sort((e,t)=>t.time.updated-e.time.updated),l=new Date;l.setDate(l.getDate()-i);let u=l.getTime(),d=new Set;for(let e of c)e.time.updated>=u&&d.add(e.id);for(let e=0;e<Math.min(r,c.length);e++){let t=c[e];t!=null&&d.add(t.id)}let f=c.filter(e=>!d.has(e.id)),p=new Set;for(let e of f){p.add(e.id);for(let t of o)t.parentID===e.id&&p.add(t.id)}if(p.size===0)return n.info(`No sessions to prune`),{prunedCount:0,prunedSessionIds:[],remainingCount:s.length,freedBytes:0};let m=0,h=[];for(let e of p)try{let t=await Ft(a.id,e,n);m+=t,h.push(e),n.debug(`Pruned session`,{sessionId:e,bytes:t})}catch(t){n.warning(`Failed to prune session`,{sessionId:e,error:t instanceof Error?t.message:String(t)})}let g=s.length-f.length;return n.info(`Session pruning complete`,{prunedCount:h.length,remainingCount:g,freedBytes:m}),{prunedCount:h.length,prunedSessionIds:h,remainingCount:g,freedBytes:m}}async function zt(e,t,n){let{limit:r,fromDate:i,toDate:a}=t;n.debug(`Listing sessions`,{directory:e,limit:r});let o=await jt(e,n);if(o==null)return n.debug(`No project found for directory`,{directory:e}),[];let s=[...(await Y(o.id,n)).filter(e=>!(e.parentID!=null||i!=null&&e.time.created<i.getTime()||a!=null&&e.time.created>a.getTime()))].sort((e,t)=>t.time.updated-e.time.updated),c=[],l=r==null?s:s.slice(0,r);for(let e of l){let t=await X(e.id,n),r=Bt(t);c.push({id:e.id,projectID:e.projectID,directory:e.directory,title:e.title,createdAt:e.time.created,updatedAt:e.time.updated,messageCount:t.length,agents:r,isChild:!1})}return n.info(`Listed sessions`,{count:c.length,directory:e}),c}function Bt(e){let t=new Set;for(let n of e)n.agent!=null&&t.add(n.agent);return[...t]}async function Vt(e,t,n,r){let{limit:i=20,caseSensitive:a=!1,sessionId:o}=n;r.debug(`Searching sessions`,{query:e,directory:t,limit:i,caseSensitive:a});let s=a?e:e.toLowerCase(),c=[],l=0;if(o!=null){let e=await Ht(o,s,a,r);return e.length>0&&c.push({sessionId:o,matches:e.slice(0,i)}),c}let u=await zt(t,{},r);for(let e of u){if(l>=i)break;let t=await Ht(e.id,s,a,r);if(t.length>0){let n=i-l;c.push({sessionId:e.id,matches:t.slice(0,n)}),l+=Math.min(t.length,n)}}return r.info(`Session search complete`,{query:e,resultCount:c.length,totalMatches:l}),c}async function Ht(e,t,n,r){let i=await X(e,r),a=[];for(let e of i){let i=await Mt(e.id,r);for(let r of i){let i=Ut(r);if(i==null)continue;let o=n?i:i.toLowerCase();if(o.includes(t)){let n=o.indexOf(t),s=Math.max(0,n-50),c=Math.min(i.length,n+t.length+50),l=i.slice(s,c);a.push({messageId:e.id,partId:r.id,excerpt:`...${l}...`,role:e.role,agent:e.agent})}}}return a}function Ut(e){switch(e.type){case`text`:return e.text;case`reasoning`:return e.reasoning;case`tool`:return e.state.status===`completed`?`${e.tool}: ${e.state.output}`:null;case`step-finish`:return null}}function Wt(e){let t=``;for(let n=0;n<e;n++)t+=`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz`.charAt(Math.floor(Math.random()*62));return t}function Gt(e){let t=[`--- Fro Bot Run Summary ---`,`Event: ${e.eventType}`,`Repo: ${e.repo}`,`Ref: ${e.ref}`,`Run ID: ${e.runId}`,`Cache: ${e.cacheStatus}`,`Duration: ${e.duration}s`];return e.sessionIds.length>0&&t.push(`Sessions used: ${e.sessionIds.join(`, `)}`),e.createdPRs.length>0&&t.push(`PRs created: ${e.createdPRs.join(`, `)}`),e.createdCommits.length>0&&t.push(`Commits: ${e.createdCommits.join(`, `)}`),e.tokenUsage!=null&&t.push(`Tokens: ${e.tokenUsage.input} in / ${e.tokenUsage.output} out`),t.join(`
`)}async function Kt(e,t,n){let r=q(),i=T.join(r,`message`,e),a=T.join(r,`part`),o=Date.now(),s=`msg_${o.toString(16)}${Wt(14)}`,c=`prt_${o.toString(16)}${Wt(14)}`,l={id:s,sessionID:e,role:`user`,time:{created:o},summary:{title:`GitHub Action Run Summary`,diffs:[]},agent:`fro-bot`,model:{providerID:`system`,modelID:`run-summary`}},u={id:c,sessionID:e,messageID:s,type:`text`,text:Gt(t),time:{start:o,end:o}};try{await D.mkdir(i,{recursive:!0}),await D.mkdir(T.join(a,s),{recursive:!0});let t=T.join(i,`${s}.json`),r=T.join(a,s,`${c}.json`);await D.writeFile(t,JSON.stringify(l,null,2),`utf8`),await D.writeFile(r,JSON.stringify(u,null,2),`utf8`),n.info(`Session summary written`,{sessionId:e,messageId:s})}catch(t){n.warning(`Failed to write session summary`,{sessionId:e,error:t instanceof Error?t.message:String(t)})}}const qt=/^[0-9a-f]{40}$/i;function Jt(){return{exec:I.exec,getExecOutput:I.getExecOutput}}async function Yt(e){let{workspacePath:t,logger:n,execAdapter:r=Jt()}=e,i=T.join(t,`.git`),a=T.join(i,`opencode`);try{let e=(await D.readFile(a,`utf8`)).trim();if(e.length>0){if(qt.test(e))return n.debug(`Project ID loaded from cache`,{projectId:e}),{projectId:e,source:`cached`};n.warning(`Invalid cached project ID format, regenerating`,{cachedId:e})}}catch(e){n.debug(`No cached project ID found`,{error:e instanceof Error?e.message:String(e)})}try{if((await D.stat(i)).isDirectory()===!1){let e=await D.readFile(i,`utf8`),n=/^gitdir: (.+)$/m.exec(e);if(n==null)return{projectId:null,source:`error`,error:`Invalid .git file format`};i=T.resolve(t,n[1]),a=T.join(i,`opencode`)}}catch{return{projectId:null,source:`error`,error:`Not a git repository`}}try{let{stdout:e,exitCode:i}=await r.getExecOutput(`git`,[`rev-list`,`--max-parents=0`,`--all`],{cwd:t,silent:!0});if(i!==0||e.trim().length===0)return{projectId:null,source:`error`,error:`No commits found in repository`};let o=e.trim().split(`
`).map(e=>e.trim()).filter(e=>e.length>0).sort();if(o.length===0)return{projectId:null,source:`error`,error:`No root commits found`};let s=o[0];try{await D.writeFile(a,s,`utf8`),n.info(`Project ID generated and cached`,{projectId:s,source:`generated`})}catch(e){n.warning(`Failed to cache project ID (continuing)`,{error:e instanceof Error?e.message:String(e)})}return{projectId:s,source:`generated`}}catch(e){return{projectId:null,source:`error`,error:e instanceof Error?e.message:String(e)}}}const Xt={login:null,requireMention:!0,allowedAssociations:[`COLLABORATOR`,`MEMBER`,`OWNER`],skipDraftPRs:!0,promptInput:null};function Zt(e,t){return t.length===0?!1:new RegExp(String.raw`@${Qt(t)}(?:\[bot\])?(?:$|[^\w])`,`i`).test(e)}function Qt(e){return e.replaceAll(/[.*+?^${}()|[\]\\]/g,String.raw`\$&`)}function $t(e,t){if(t.length===0)return null;let n=new RegExp(String.raw`@${Qt(t)}(?:\[bot\])?\s*(.*)`,`is`).exec(e)?.[1];if(n==null)return null;let r=n.trim();if(r.length===0)return{raw:``,action:null,args:``};let i=r.split(/\s+/),a=i[0]??``;return{raw:r,action:a===``?null:a,args:i.slice(1).join(` `)}}function Z(e,t){return t.includes(e)}function Q(e){return e.endsWith(`[bot]`)}function en(e){let t=P(e);return{login:t,association:N(e),isBot:Q(t)}}function tn(e){return{kind:j(e)?`pr`:`issue`,number:e.issue.number,title:e.issue.title,body:e.comment.body??null,locked:F(e)}}function $(e,t){if(t==null||t===``||e==null)return{hasMention:!1,command:null};let n=Zt(e,t);return{hasMention:n,command:n?$t(e,t):null}}function nn(e,t){let n=en(e),r=tn(e),i=e.comment.body,a=e.comment.id,{hasMention:o,command:s}=$(i,t);return{author:n,target:r,commentBody:i,commentId:a,hasMention:o,command:s}}function rn(e,t){let n=e.discussion,r=e.comment,i={login:r.user.login,association:r.author_association??`NONE`,isBot:Q(r.user.login)},a={kind:`discussion`,number:n.number,title:n.title,body:r.body??n.body??null,locked:n.locked??!1},o=r.body??null,s=r.id,{hasMention:c,command:l}=$(o,t);return{author:i,target:a,commentBody:o,commentId:s,hasMention:c,command:l}}function an(e,t){let n=e.inputs?.prompt??``;return{author:{login:t,association:`OWNER`,isBot:!1},target:{kind:`manual`,number:0,title:`Manual workflow dispatch`,body:n===``?null:n,locked:!1},commentBody:n===``?null:n,commentId:null,hasMention:!1,command:null}}function on(e,t){let n=e.issue,r=n.body??``,i={login:e.sender.login,association:n.author_association??`NONE`,isBot:Q(e.sender.login)},a={kind:`issue`,number:n.number,title:n.title,body:n.body??null,locked:n.locked??!1},{hasMention:o,command:s}=$(r,t);return{author:i,target:a,commentBody:n.body,commentId:null,hasMention:o,command:s}}const sn=[`opened`,`edited`];function cn(e){return sn.includes(e)}function ln(e,t,n){let r=e.raw.payload.action;return cn(r)?e.author!=null&&e.author.isBot?(n.debug(`Skipping bot actor`,{bot:e.author.login}),{shouldSkip:!0,reason:`self_comment`,message:`Issues from bots (${e.author.login}) are not processed`}):e.author!=null&&!Z(e.author.association,t.allowedAssociations)?(n.debug(`Skipping unauthorized author`,{association:e.author.association,allowed:t.allowedAssociations}),{shouldSkip:!0,reason:`unauthorized_author`,message:`Author association '${e.author.association}' is not authorized`}):r===`edited`&&!e.hasMention?(n.debug(`Skipping issues.edited without bot mention`),{shouldSkip:!0,reason:`no_mention`,message:`Issue edit does not mention the bot`}):e.target?.locked===!0?(n.debug(`Skipping locked issue`),{shouldSkip:!0,reason:`issue_locked`,message:`Issue is locked`}):{shouldSkip:!1}:(n.debug(`Skipping unsupported issues action`,{action:r}),{shouldSkip:!0,reason:`action_not_supported`,message:`Issues action '${r}' is not supported (only 'opened' and 'edited')`})}function un(e,t){let n=e.pull_request,r=n.body??``,i={login:e.sender.login,association:n.author_association??`NONE`,isBot:Q(e.sender.login)},a={kind:`pr`,number:n.number,title:n.title,body:n.body??null,locked:n.locked??!1,isDraft:n.draft??!1},{hasMention:o,command:s}=$(r,t);return{author:i,target:a,commentBody:n.body,commentId:null,hasMention:o,command:s}}const dn=[`opened`,`synchronize`,`reopened`];function fn(e){return dn.includes(e)}function pn(e,t,n){let r=e.raw.payload.action;return fn(r)?e.author!=null&&e.author.isBot?(n.debug(`Skipping bot actor`,{bot:e.author.login}),{shouldSkip:!0,reason:`self_comment`,message:`Pull requests from bots (${e.author.login}) are not processed`}):e.author!=null&&!Z(e.author.association,t.allowedAssociations)?(n.debug(`Skipping unauthorized author`,{association:e.author.association,allowed:t.allowedAssociations}),{shouldSkip:!0,reason:`unauthorized_author`,message:`Author association '${e.author.association}' is not authorized`}):t.skipDraftPRs&&e.target?.isDraft===!0?(n.debug(`Skipping draft PR`),{shouldSkip:!0,reason:`draft_pr`,message:`Pull request is a draft`}):e.target?.locked===!0?(n.debug(`Skipping locked pull request`),{shouldSkip:!0,reason:`issue_locked`,message:`Pull request is locked`}):{shouldSkip:!1}:(n.debug(`Skipping unsupported pull_request action`,{action:r}),{shouldSkip:!0,reason:`action_not_supported`,message:`Pull request action '${r}' is not supported`})}function mn(e,t){let n=e.pull_request,r=e.comment,i={login:r.user.login,association:r.author_association,isBot:Q(r.user.login)},a={kind:`pr`,number:n.number,title:n.title,body:r.body,locked:n.locked??!1,path:r.path,line:r.line??void 0,diffHunk:r.diff_hunk,commitId:r.commit_id},{hasMention:o,command:s}=$(r.body,t);return{author:i,target:a,commentBody:r.body,commentId:r.id,hasMention:o,command:s}}function hn(e,t,n){let r=n?.trim()??``;return{author:{login:t,association:`OWNER`,isBot:!1},target:{kind:`manual`,number:0,title:`Scheduled workflow`,body:r===``?null:r,locked:!1},commentBody:r===``?null:r,commentId:null,hasMention:!1,command:null}}function gn(e,t){return(e.promptInput?.trim()??``)===``?(t.debug(`Skipping schedule event without prompt input`),{shouldSkip:!0,reason:`prompt_required`,message:`Schedule trigger requires prompt input`}):{shouldSkip:!1}}function _n(e,t){return(e.commentBody?.trim()??``)===``?(t.debug(`Skipping workflow_dispatch event without prompt input`),{shouldSkip:!0,reason:`prompt_required`,message:`Workflow dispatch requires prompt input`}):{shouldSkip:!1}}function vn(e,t,n,r){let i=e.raw.payload,{targetLabel:a,actionLabel:o}=r;return i.action===`created`?e.target?.locked===!0?(n.debug(`Skipping locked ${a}`),{shouldSkip:!0,reason:`issue_locked`,message:`${a} is locked`}):e.author!=null&&e.author.isBot?(n.debug(`Skipping bot actor`,{bot:e.author.login}),{shouldSkip:!0,reason:`self_comment`,message:`Comments from bots (${e.author.login}) are not processed`}):e.author!=null&&!Z(e.author.association,t.allowedAssociations)?(n.debug(`Skipping unauthorized author`,{association:e.author.association,allowed:t.allowedAssociations}),{shouldSkip:!0,reason:`unauthorized_author`,message:`Author association '${e.author.association}' is not authorized`}):t.requireMention&&!e.hasMention?(n.debug(`Skipping ${o} without bot mention`),{shouldSkip:!0,reason:`no_mention`,message:`Comment does not mention the bot`}):{shouldSkip:!1}:(n.debug(`Skipping non-created ${o} action`,{action:i.action}),{shouldSkip:!0,reason:`action_not_created`,message:`${o} action is '${i.action}', not 'created'`})}function yn(e,t,n){return vn(e,t,n,{targetLabel:`Issue or PR`,actionLabel:`Comment`})}function bn(e,t,n){return vn(e,t,n,{targetLabel:`Discussion`,actionLabel:`Discussion comment`})}const xn=[`created`];function Sn(e,t,n){let r=e.raw.payload;return xn.includes(r.action)?e.target?.locked===!0?(n.debug(`Skipping locked pull request`),{shouldSkip:!0,reason:`issue_locked`,message:`Pull request is locked`}):e.author!=null&&e.author.isBot?(n.debug(`Skipping bot actor`,{bot:e.author.login}),{shouldSkip:!0,reason:`self_comment`,message:`Review comments from bots (${e.author.login}) are not processed`}):e.author!=null&&!Z(e.author.association,t.allowedAssociations)?(n.debug(`Skipping unauthorized author`,{association:e.author.association,allowed:t.allowedAssociations}),{shouldSkip:!0,reason:`unauthorized_author`,message:`Author association '${e.author.association}' is not authorized`}):t.requireMention&&!e.hasMention?(n.debug(`Skipping review comment without bot mention`),{shouldSkip:!0,reason:`no_mention`,message:`Review comment does not mention the bot`}):{shouldSkip:!1}:(n.debug(`Skipping non-created review comment action`,{action:r.action}),{shouldSkip:!0,reason:`action_not_created`,message:`Review comment action '${r.action}' is not supported (only 'created')`})}function Cn(e,t,n){if(e.eventType===`unsupported`)return n.debug(`Skipping unsupported event`,{eventName:e.eventName}),{shouldSkip:!0,reason:`unsupported_event`,message:`Unsupported event type: ${e.eventName}`};switch(e.eventType){case`issue_comment`:return yn(e,t,n);case`discussion_comment`:return bn(e,t,n);case`issues`:return ln(e,t,n);case`pull_request`:return pn(e,t,n);case`pull_request_review_comment`:return Sn(e,t,n);case`schedule`:return gn(t,n);case`workflow_dispatch`:return _n(e,n);default:return{shouldSkip:!1}}}function wn(e,t,n){let r={eventType:e.eventType,eventName:e.eventName,repo:e.repo,ref:e.ref,sha:e.sha,runId:e.runId,actor:e.actor,raw:e};switch(e.eventType){case`issue_comment`:{let n=e.payload,i=nn(n,t);return{...r,author:i.author,target:i.target,commentBody:i.commentBody,commentId:i.commentId,hasMention:i.hasMention,command:i.command}}case`discussion_comment`:{let n=e.payload,i=rn(n,t);return{...r,author:i.author,target:i.target,commentBody:i.commentBody,commentId:i.commentId,hasMention:i.hasMention,command:i.command}}case`workflow_dispatch`:{let t=e.payload,n=an(t,e.actor);return{...r,author:n.author,target:n.target,commentBody:n.commentBody,commentId:n.commentId,hasMention:n.hasMention,command:n.command}}case`issues`:{let n=e.payload,i=on(n,t);return{...r,author:i.author,target:i.target,commentBody:i.commentBody,commentId:i.commentId,hasMention:i.hasMention,command:i.command}}case`pull_request`:{let n=e.payload,i=un(n,t);return{...r,author:i.author,target:i.target,commentBody:i.commentBody,commentId:i.commentId,hasMention:i.hasMention,command:i.command}}case`pull_request_review_comment`:{let n=e.payload,i=mn(n,t);return{...r,author:i.author,target:i.target,commentBody:i.commentBody,commentId:i.commentId,hasMention:i.hasMention,command:i.command}}case`schedule`:{let t=e.payload,i=hn(t,e.actor,n);return{...r,author:i.author,target:i.target,commentBody:i.commentBody,commentId:i.commentId,hasMention:i.hasMention,command:i.command}}case`unsupported`:return{...r,author:null,target:null,commentBody:null,commentId:null,hasMention:!1,command:null}}}function Tn(e,t,n={}){let r={...Xt,...n},i=wn(e,r.login,r.promptInput);t.debug(`Routing event`,{eventName:e.eventName,eventType:e.eventType,hasMention:i.hasMention});let a=Cn(i,r,t);return a.shouldSkip?{shouldProcess:!1,skipReason:a.reason,skipMessage:a.message,context:i}:{shouldProcess:!0,context:i}}async function En(){let e=Date.now(),t=d({phase:`bootstrap`}),r=null,o=!1,s=0,p=null;O.saveState(w.SHOULD_SAVE_CACHE,`false`),O.saveState(w.CACHE_SAVED,`false`);try{t.info(`Starting Fro Bot Agent`);let u=Ot();if(!u.success)return O.setFailed(`Invalid inputs: ${u.error.message}`),1;let m=u.data,h=d({phase:`main`});h.info(`Action inputs parsed`,{sessionRetention:m.sessionRetention,s3Backup:m.s3Backup,hasGithubToken:m.githubToken.length>0,hasPrompt:m.prompt!=null,agent:m.agent,hasModelOverride:m.model!=null,timeoutMs:m.timeoutMs});let _=await pt({logger:h,opencodeVersion:m.opencodeVersion});_.didSetup?h.info(`OpenCode auto-setup completed`,{version:_.version}):h.info(`OpenCode already available`,{version:_.version});let v=d({phase:`context`}),y=se(v);p=ee({token:m.githubToken,logger:v});let b=await g(p,y.repo,v),x={...y,defaultBranch:b},S=d({phase:`trigger`}),ne=oe(S),C=Tn(ne,S,{login:ne.actor,requireMention:!0});if(!C.shouldProcess)return S.info(`Skipping event`,{reason:C.skipReason,message:C.skipMessage}),K({sessionId:null,cacheStatus:`miss`,duration:Date.now()-e}),0;S.info(`Event routed for processing`,{eventType:C.context.eventType,hasMention:C.context.hasMention,command:C.context.command?.action??null}),O.saveState(w.SHOULD_SAVE_CACHE,`true`);let ie=await te(p,v);r={repo:y.repo,commentId:y.commentId,issueNumber:y.issueNumber,issueType:y.issueType,botLogin:ie};let ae=d({phase:`acknowledgment`});await gt(p,r,ae);let D={agentIdentity:`github`,repo:l(),ref:n(),os:a()},k=d({phase:`cache`}),A=i(),j=T.join(A,`.git`,`opencode`),M=await re({components:D,logger:k,storagePath:f(),authPath:c(),projectIdPath:j}),N=M.corrupted?`corrupted`:M.hit?`hit`:`miss`;h.info(`Cache restore completed`,{cacheStatus:N,key:M.key});let P=await Yt({workspacePath:A,logger:k});P.source===`error`?k.warning(`Failed to generate project ID (continuing)`,{error:P.error}):k.debug(`Project ID ready`,{projectId:P.projectId,source:P.source});let F=d({phase:`session`}),I=await zt(A,{limit:10},F);F.debug(`Listed recent sessions`,{count:I.length});let L=x.issueTitle??x.repo,R=await Vt(L,A,{limit:5},F);F.debug(`Searched prior sessions`,{query:L,resultCount:R.length});let ce={context:x,customPrompt:m.prompt,cacheStatus:N,sessionContext:{recentSessions:I,priorWorkContext:R},triggerContext:C.context},le=E.env.SKIP_AGENT_EXECUTION===`true`,z,ue=Date.now();if(le)h.info(`Skipping agent execution (SKIP_AGENT_EXECUTION=true)`),z={success:!0,exitCode:0,sessionId:null,error:null};else{let e=await dt(ce,d({phase:`execution`}),{agent:m.agent,model:m.model,timeoutMs:m.timeoutMs}),t=e.sessionId;if(t==null){let e=await It(ue,F);e!=null&&(t=e.session.id,F.debug(`Identified session from execution`,{sessionId:t}))}z={...e,sessionId:t}}if(z.sessionId!=null&&O.saveState(w.SESSION_ID,z.sessionId),o=z.success,z.sessionId!=null){let t={eventType:x.eventName,repo:x.repo,ref:x.ref,runId:Number(x.runId),cacheStatus:N,sessionIds:[z.sessionId],createdPRs:[],createdCommits:[],duration:Math.round((Date.now()-e)/1e3),tokenUsage:null};await Kt(z.sessionId,t,F),F.debug(`Wrote session summary`,{sessionId:z.sessionId})}let B=Date.now()-e;K({sessionId:z.sessionId,cacheStatus:N,duration:B}),z.success?h.info(`Agent run completed successfully`,{durationMs:B}):(s=z.exitCode,O.setFailed(`Agent execution failed with exit code ${z.exitCode}`))}catch(n){s=1,K({sessionId:null,cacheStatus:`miss`,duration:Date.now()-e}),n instanceof Error?(t.error(`Agent failed`,{error:n.message}),O.setFailed(n.message)):(t.error(`Agent failed with unknown error`),O.setFailed(`An unknown error occurred`))}finally{try{if(r!=null&&p!=null){let e=d({phase:`cleanup`});await St(p,r,o,e)}let e=d({phase:`prune`}),t=await Rt(f(),Lt,e);t.prunedCount>0&&e.info(`Pruned old sessions`,{pruned:t.prunedCount,remaining:t.remainingCount});let s={agentIdentity:`github`,repo:l(),ref:n(),os:a()},m=d({phase:`cache-save`}),h=i(),g=T.join(h,`.git`,`opencode`);await C({components:s,runId:u(),logger:m,storagePath:f(),authPath:c(),projectIdPath:g})&&O.saveState(w.CACHE_SAVED,`true`)}catch(e){t.warning(`Cleanup failed (non-fatal)`,{error:e instanceof Error?e.message:String(e)})}}return s}await En().then(e=>{E.exit(e)});export{};