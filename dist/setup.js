import{C as e,D as t,E as n,S as r,T as i,c as a,f as o,g as s,h as c,l,m as u,o as d,p as f,s as p,u as m,x as h}from"./env-De5yR9mB.js";import g from"node:process";import*as _ from"node:fs/promises";import v from"node:fs/promises";import*as y from"node:path";import b,{join as x}from"node:path";import S from"node:os";var C=i(((e,t)=>{var r=e&&e.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),i=e&&e.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),a=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!==`default`&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},o=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(e,`__esModule`,{value:!0}),e._readLinuxVersionFile=e._getOsVersion=e._findMatch=void 0;let s=a(f()),c=u(),l=n(`os`),d=n(`child_process`),p=n(`fs`);function m(e,n,r,i){return o(this,void 0,void 0,function*(){let a=l.platform(),o,u,d;for(let o of r){let r=o.version;if((0,c.debug)(`check ${r} satisfies ${e}`),s.satisfies(r,e)&&(!n||o.stable===n)&&(d=o.files.find(e=>{(0,c.debug)(`${e.arch}===${i} && ${e.platform}===${a}`);let n=e.arch===i&&e.platform===a;if(n&&e.platform_version){let r=t.exports._getOsVersion();n=r===e.platform_version?!0:s.satisfies(r,e.platform_version)}return n}),d)){(0,c.debug)(`matched ${o.version}`),u=o;break}}return u&&d&&(o=Object.assign({},u),o.files=[d]),o})}e._findMatch=m;function h(){let e=l.platform(),n=``;if(e===`darwin`)n=d.execSync(`sw_vers -productVersion`).toString();else if(e===`linux`){let e=t.exports._readLinuxVersionFile();if(e){let t=e.split(`
`);for(let e of t){let t=e.split(`=`);if(t.length===2&&(t[0].trim()===`VERSION_ID`||t[0].trim()===`DISTRIB_RELEASE`)){n=t[1].trim().replace(/^"/,``).replace(/"$/,``);break}}}}return n}e._getOsVersion=h;function g(){let e=`/etc/lsb-release`,t=`/etc/os-release`,n=``;return p.existsSync(e)?n=p.readFileSync(e).toString():p.existsSync(t)&&(n=p.readFileSync(t).toString()),n}e._readLinuxVersionFile=g})),w=i((e=>{var t=e&&e.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),n=e&&e.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),r=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var i in e)i!==`default`&&Object.prototype.hasOwnProperty.call(e,i)&&t(r,e,i);return n(r,e),r},i=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(e,`__esModule`,{value:!0}),e.RetryHelper=void 0;let a=r(u());e.RetryHelper=class{constructor(e,t,n){if(e<1)throw Error(`max attempts should be greater than or equal to 1`);if(this.maxAttempts=e,this.minSeconds=Math.floor(t),this.maxSeconds=Math.floor(n),this.minSeconds>this.maxSeconds)throw Error(`min seconds should be less than or equal to max seconds`)}execute(e,t){return i(this,void 0,void 0,function*(){let n=1;for(;n<this.maxAttempts;){try{return yield e()}catch(e){if(t&&!t(e))throw e;a.info(e.message)}let r=this.getSleepAmount();a.info(`Waiting ${r} seconds before trying again`),yield this.sleep(r),n++}return yield e()})}getSleepAmount(){return Math.floor(Math.random()*(this.maxSeconds-this.minSeconds+1))+this.minSeconds}sleep(e){return i(this,void 0,void 0,function*(){return new Promise(t=>setTimeout(t,e*1e3))})}}})),T=t(i((e=>{var t=e&&e.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),r=e&&e.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),i=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(e!=null)for(var i in e)i!==`default`&&Object.prototype.hasOwnProperty.call(e,i)&&t(n,e,i);return r(n,e),n},a=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(e,`__esModule`,{value:!0}),e.evaluateVersions=e.isExplicitVersion=e.findFromManifest=e.getManifestFromRepo=e.findAllVersions=e.find=e.cacheFile=e.cacheDir=e.extractZip=e.extractXar=e.extractTar=e.extract7z=e.downloadTool=e.HTTPError=void 0;let o=i(u()),l=i(s()),d=i(n(`crypto`)),p=i(n(`fs`)),m=i(C()),g=i(n(`os`)),_=i(n(`path`)),v=i(h()),y=i(f()),b=i(n(`stream`)),x=i(n(`util`)),S=n(`assert`),T=c(),E=w();var D=class extends Error{constructor(e){super(`Unexpected HTTP response: ${e}`),this.httpStatusCode=e,Object.setPrototypeOf(this,new.target.prototype)}};e.HTTPError=D;let O=process.platform===`win32`,k=process.platform===`darwin`;function A(e,t,n,r){return a(this,void 0,void 0,function*(){t||=_.join(X(),d.randomUUID()),yield l.mkdirP(_.dirname(t)),o.debug(`Downloading ${e}`),o.debug(`Destination ${t}`);let i=Z(`TEST_DOWNLOAD_TOOL_RETRY_MIN_SECONDS`,10),s=Z(`TEST_DOWNLOAD_TOOL_RETRY_MAX_SECONDS`,20);return yield new E.RetryHelper(3,i,s).execute(()=>a(this,void 0,void 0,function*(){return yield j(e,t||``,n,r)}),e=>!(e instanceof D&&e.httpStatusCode&&e.httpStatusCode<500&&e.httpStatusCode!==408&&e.httpStatusCode!==429))})}e.downloadTool=A;function j(e,t,n,r){return a(this,void 0,void 0,function*(){if(p.existsSync(t))throw Error(`Destination file path ${t} already exists`);let i=new v.HttpClient(`actions/tool-cache`,[],{allowRetries:!1});n&&(o.debug(`set auth`),r===void 0&&(r={}),r.authorization=n);let a=yield i.get(e,r);if(a.message.statusCode!==200){let t=new D(a.message.statusCode);throw o.debug(`Failed to download from "${e}". Code(${a.message.statusCode}) Message(${a.message.statusMessage})`),t}let s=x.promisify(b.pipeline),c=Z(`TEST_DOWNLOAD_TOOL_RESPONSE_MESSAGE_FACTORY`,()=>a.message)(),u=!1;try{return yield s(c,p.createWriteStream(t)),o.debug(`download complete`),u=!0,t}finally{if(!u){o.debug(`download failed`);try{yield l.rmRF(t)}catch(e){o.debug(`Failed to delete '${t}'. ${e.message}`)}}}})}function M(e,t,n){return a(this,void 0,void 0,function*(){(0,S.ok)(O,`extract7z() not supported on current OS`),(0,S.ok)(e,`parameter "file" is required`),t=yield W(t);let r=process.cwd();if(process.chdir(t),n)try{let t=[`x`,o.isDebug()?`-bb1`:`-bb0`,`-bd`,`-sccUTF-8`,e];yield(0,T.exec)(`"${n}"`,t,{silent:!0})}finally{process.chdir(r)}else{let n=[`-NoLogo`,`-Sta`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,`& '${_.join(__dirname,`..`,`scripts`,`Invoke-7zdec.ps1`).replace(/'/g,`''`).replace(/"|\n|\r/g,``)}' -Source '${e.replace(/'/g,`''`).replace(/"|\n|\r/g,``)}' -Target '${t.replace(/'/g,`''`).replace(/"|\n|\r/g,``)}'`],i={silent:!0};try{let e=yield l.which(`powershell`,!0);yield(0,T.exec)(`"${e}"`,n,i)}finally{process.chdir(r)}}return t})}e.extract7z=M;function N(e,t,n=`xz`){return a(this,void 0,void 0,function*(){if(!e)throw Error(`parameter 'file' is required`);t=yield W(t),o.debug(`Checking tar --version`);let r=``;yield(0,T.exec)(`tar --version`,[],{ignoreReturnCode:!0,silent:!0,listeners:{stdout:e=>r+=e.toString(),stderr:e=>r+=e.toString()}}),o.debug(r.trim());let i=r.toUpperCase().includes(`GNU TAR`),a;a=n instanceof Array?n:[n],o.isDebug()&&!n.includes(`v`)&&a.push(`-v`);let s=t,c=e;return O&&i&&(a.push(`--force-local`),s=t.replace(/\\/g,`/`),c=e.replace(/\\/g,`/`)),i&&(a.push(`--warning=no-unknown-keyword`),a.push(`--overwrite`)),a.push(`-C`,s,`-f`,c),yield(0,T.exec)(`tar`,a),t})}e.extractTar=N;function P(e,t,n=[]){return a(this,void 0,void 0,function*(){(0,S.ok)(k,`extractXar() not supported on current OS`),(0,S.ok)(e,`parameter "file" is required`),t=yield W(t);let r;r=n instanceof Array?n:[n],r.push(`-x`,`-C`,t,`-f`,e),o.isDebug()&&r.push(`-v`);let i=yield l.which(`xar`,!0);return yield(0,T.exec)(`"${i}"`,Q(r)),t})}e.extractXar=P;function F(e,t){return a(this,void 0,void 0,function*(){if(!e)throw Error(`parameter 'file' is required`);return t=yield W(t),O?yield I(e,t):yield L(e,t),t})}e.extractZip=F;function I(e,t){return a(this,void 0,void 0,function*(){let n=e.replace(/'/g,`''`).replace(/"|\n|\r/g,``),r=t.replace(/'/g,`''`).replace(/"|\n|\r/g,``),i=yield l.which(`pwsh`,!1);if(i){let e=[`-NoLogo`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,[`$ErrorActionPreference = 'Stop' ;`,`try { Add-Type -AssemblyName System.IO.Compression.ZipFile } catch { } ;`,`try { [System.IO.Compression.ZipFile]::ExtractToDirectory('${n}', '${r}', $true) }`,`catch { if (($_.Exception.GetType().FullName -eq 'System.Management.Automation.MethodException') -or ($_.Exception.GetType().FullName -eq 'System.Management.Automation.RuntimeException') ){ Expand-Archive -LiteralPath '${n}' -DestinationPath '${r}' -Force } else { throw $_ } } ;`].join(` `)];o.debug(`Using pwsh at path: ${i}`),yield(0,T.exec)(`"${i}"`,e)}else{let e=[`-NoLogo`,`-Sta`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,[`$ErrorActionPreference = 'Stop' ;`,`try { Add-Type -AssemblyName System.IO.Compression.FileSystem } catch { } ;`,`if ((Get-Command -Name Expand-Archive -Module Microsoft.PowerShell.Archive -ErrorAction Ignore)) { Expand-Archive -LiteralPath '${n}' -DestinationPath '${r}' -Force }`,`else {[System.IO.Compression.ZipFile]::ExtractToDirectory('${n}', '${r}', $true) }`].join(` `)],t=yield l.which(`powershell`,!0);o.debug(`Using powershell at path: ${t}`),yield(0,T.exec)(`"${t}"`,e)}})}function L(e,t){return a(this,void 0,void 0,function*(){let n=yield l.which(`unzip`,!0),r=[e];o.isDebug()||r.unshift(`-q`),r.unshift(`-o`),yield(0,T.exec)(`"${n}"`,r,{cwd:t})})}function R(e,t,n,r){return a(this,void 0,void 0,function*(){if(n=y.clean(n)||n,r||=g.arch(),o.debug(`Caching tool ${t} ${n} ${r}`),o.debug(`source dir: ${e}`),!p.statSync(e).isDirectory())throw Error(`sourceDir is not a directory`);let i=yield G(t,n,r);for(let t of p.readdirSync(e)){let n=_.join(e,t);yield l.cp(n,i,{recursive:!0})}return K(t,n,r),i})}e.cacheDir=R;function z(e,t,n,r,i){return a(this,void 0,void 0,function*(){if(r=y.clean(r)||r,i||=g.arch(),o.debug(`Caching tool ${n} ${r} ${i}`),o.debug(`source file: ${e}`),!p.statSync(e).isFile())throw Error(`sourceFile is not a file`);let a=yield G(n,r,i),s=_.join(a,t);return o.debug(`destination file ${s}`),yield l.cp(e,s),K(n,r,i),a})}e.cacheFile=z;function B(e,t,n){if(!e)throw Error(`toolName parameter is required`);if(!t)throw Error(`versionSpec parameter is required`);n||=g.arch(),q(t)||(t=J(V(e,n),t));let r=``;if(t){t=y.clean(t)||``;let i=_.join(Y(),e,t,n);o.debug(`checking cache: ${i}`),p.existsSync(i)&&p.existsSync(`${i}.complete`)?(o.debug(`Found tool in cache ${e} ${t} ${n}`),r=i):o.debug(`not found`)}return r}e.find=B;function V(e,t){let n=[];t||=g.arch();let r=_.join(Y(),e);if(p.existsSync(r)){let e=p.readdirSync(r);for(let i of e)if(q(i)){let e=_.join(r,i,t||``);p.existsSync(e)&&p.existsSync(`${e}.complete`)&&n.push(i)}}return n}e.findAllVersions=V;function H(e,t,n,r=`master`){return a(this,void 0,void 0,function*(){let i=[],a=`https://api.github.com/repos/${e}/${t}/git/trees/${r}`,s=new v.HttpClient(`tool-cache`),c={};n&&(o.debug(`set auth`),c.authorization=n);let l=yield s.getJson(a,c);if(!l.result)return i;let u=``;for(let e of l.result.tree)if(e.path===`versions-manifest.json`){u=e.url;break}c.accept=`application/vnd.github.VERSION.raw`;let d=yield(yield s.get(u,c)).readBody();if(d){d=d.replace(/^\uFEFF/,``);try{i=JSON.parse(d)}catch{o.debug(`Invalid json`)}}return i})}e.getManifestFromRepo=H;function U(e,t,n,r=g.arch()){return a(this,void 0,void 0,function*(){return yield m._findMatch(e,t,n,r)})}e.findFromManifest=U;function W(e){return a(this,void 0,void 0,function*(){return e||=_.join(X(),d.randomUUID()),yield l.mkdirP(e),e})}function G(e,t,n){return a(this,void 0,void 0,function*(){let r=_.join(Y(),e,y.clean(t)||t,n||``);o.debug(`destination ${r}`);let i=`${r}.complete`;return yield l.rmRF(r),yield l.rmRF(i),yield l.mkdirP(r),r})}function K(e,t,n){let r=`${_.join(Y(),e,y.clean(t)||t,n||``)}.complete`;p.writeFileSync(r,``),o.debug(`finished caching tool`)}function q(e){let t=y.clean(e)||``;o.debug(`isExplicit: ${t}`);let n=y.valid(t)!=null;return o.debug(`explicit? ${n}`),n}e.isExplicitVersion=q;function J(e,t){let n=``;o.debug(`evaluating ${e.length} versions`),e=e.sort((e,t)=>y.gt(e,t)?1:-1);for(let r=e.length-1;r>=0;r--){let i=e[r];if(y.satisfies(i,t)){n=i;break}}return n?o.debug(`matched: ${n}`):o.debug(`match not found`),n}e.evaluateVersions=J;function Y(){let e=process.env.RUNNER_TOOL_CACHE||``;return(0,S.ok)(e,`Expected RUNNER_TOOL_CACHE to be defined`),e}function X(){let e=process.env.RUNNER_TEMP||``;return(0,S.ok)(e,`Expected RUNNER_TEMP to be defined`),e}function Z(e,t){let n=global[e];return n===void 0?t:n}function Q(e){return Array.from(new Set(e))}}))()),E=t(o()),D=t(r()),O=t(e());function k(e){let t;try{t=JSON.parse(e)}catch(e){throw e instanceof SyntaxError?Error(`Invalid auth-json format: ${e.message}`):e}if(typeof t!=`object`||!t||Array.isArray(t))throw Error(`auth-json must be a JSON object`);return t}async function A(e,t,n){let r=y.join(t,`auth.json`);await _.mkdir(t,{recursive:!0});let i=JSON.stringify(e,null,2);return await _.writeFile(r,i,{mode:384}),n.info(`Populated auth.json`,{path:r,providers:Object.keys(e).length}),r}async function j(e,t,n,r){let i=e??t,a=e==null?t.length>0?`github-token`:`none`:`app-token`;return i.length===0?(n.warning(`No GitHub token available for gh CLI`),{authenticated:!1,method:`none`,botLogin:null}):(g.env.GH_TOKEN=i,n.info(`Configured gh CLI authentication`,{method:a}),{authenticated:!0,method:a,botLogin:await M(i,n,r)})}async function M(e,t,n){try{let{stdout:r}=await n.getExecOutput(`gh`,[`api`,`/user`,`--jq`,`.login`],{env:{...g.env,GH_TOKEN:e},silent:!0}),i=r.trim();return i.length>0?(t.info(`Authenticated as`,{login:i}),i):null}catch{return t.debug(`Could not determine bot login`),null}}async function N(e,t,n,r){let i=e==null?`fro-bot[bot]`:`${e}[bot]`,a=t!=null&&e!=null?`${t}+${e}[bot]@users.noreply.github.com`:`agent@fro.bot`;await r.exec(`git`,[`config`,`--global`,`user.name`,i],void 0),await r.exec(`git`,[`config`,`--global`,`user.email`,a],void 0),n.info(`Configured git identity`,{name:i,email:a})}function P(){let e=S.platform(),t=S.arch();return{os:{darwin:`darwin`,linux:`linux`,win32:`windows`}[e]??`linux`,arch:{arm64:`aarch64`,x64:`x64`}[t]??`x64`,ext:`.zip`}}function F(e,t){return`https://github.com/oven-sh/bun/releases/download/bun-${e.startsWith(`v`)?e:`v${e}`}/${`bun-${t.os}-${t.arch}${t.ext}`}`}async function I(e,t,n,r,i=`1.3.5`){let a=P(),o=t.find(`bun`,i,a.arch);if(o.length>0)return e.info(`Bun found in cache`,{version:i,path:o}),r(o),await R(o),{path:o,version:i,cached:!0};e.info(`Downloading Bun`,{version:i});let s=F(i,a);try{let o=await t.downloadTool(s);if(g.platform!==`win32`&&!await z(o,e,n))throw Error(`Downloaded Bun archive appears corrupted`);e.info(`Extracting Bun`);let c=await L(await t.extractZip(o),t),l=b.dirname(c);e.info(`Caching Bun`);let u=await t.cacheDir(l,`bun`,i,a.arch);return r(u),await R(u),e.info(`Bun installed`,{version:i,path:u}),{path:u,version:i,cached:!1}}catch(e){let t=e instanceof Error?e.message:String(e);throw Error(`Failed to install Bun ${i}: ${t}`)}}async function L(e,t){for(let n of await v.readdir(e,{withFileTypes:!0})){let{name:r}=n,i=b.join(e,r);if(n.isFile()){if(r===`bun`||r===`bun.exe`)return i;if(/^bun.*\.zip/.test(r))return L(await t.extractZip(i),t)}if(r.startsWith(`bun`)&&n.isDirectory())return L(i,t)}throw Error(`Could not find executable: bun`)}async function R(e){let t=e=>g.platform===`win32`?`${e}.exe`:e,n=b.join(e,t(`bun`));try{await v.symlink(n,b.join(e,t(`bunx`)))}catch(e){if(typeof e!=`object`||e.code!==`EEXIST`)throw e}}async function z(e,t,n){try{let{stdout:r}=await n.getExecOutput(`file`,[e],{silent:!0}),i=r.includes(`Zip archive`)||r.includes(`ZIP`);return i||t.warning(`Bun download validation failed`,{output:r.trim()}),i}catch{return t.debug(`Could not validate Bun download (file command unavailable)`),!0}}async function B(e){try{let{exitCode:t}=await e.getExecOutput(`bun`,[`--version`],{silent:!0,ignoreReturnCode:!0});return t===0}catch{return!1}}async function V(e,t={}){let{logger:n,execAdapter:r,toolCache:i,addPath:a}=e,{claude:o=`no`,chatgpt:s=`no`,gemini:c=`no`}=t;if(n.info(`Installing Oh My OpenCode plugin`,{claude:o,chatgpt:s,gemini:c}),!await B(r)){n.info(`Bun not found, installing...`);try{await I(n,i,r,a)}catch(e){let t=e instanceof Error?e.message:String(e);return n.error(`Failed to install Bun runtime`,{error:t}),{installed:!1,version:null,error:`Bun installation failed: ${t}`}}}let l=[`oh-my-opencode`,`install`,`--no-tui`,`--claude=${o}`,`--chatgpt=${s}`,`--gemini=${c}`];try{let e=``,t=await r.exec(`bunx`,l,{listeners:{stdout:t=>{e+=t.toString()},stderr:t=>{e+=t.toString()}},silent:!0});if(t!==0){let r=`oMo installation returned exit code ${t}`;return n.warning(r,{output:e.slice(0,500)}),{installed:!1,version:null,error:r}}let i=/oh-my-opencode@(\d+\.\d+\.\d+)/i.exec(e),a=i!=null&&i[1]!=null?i[1]:null;return n.info(`oMo plugin installed`,{version:a}),{installed:!0,version:a,error:null}}catch(e){let t=e instanceof Error?e.message:String(e);return n.error(`Failed to install oMo plugin`,{error:t}),{installed:!1,version:null,error:t}}}const H=`opencode`,U=`1.1.1`;function W(){let e=S.platform(),t=S.arch(),n={darwin:`darwin`,linux:`linux`,win32:`windows`},r={x64:`x64`,arm64:`arm64`},i=e===`win32`||e===`darwin`?`.zip`:`.tar.gz`;return{os:n[e]??`linux`,arch:r[t]??`x64`,ext:i}}function G(e,t){return`https://github.com/anomalyco/opencode/releases/download/${e.startsWith(`v`)?e:`v${e}`}/${`opencode-${t.os}-${t.arch}${t.ext}`}`}async function K(e,t,n,r){if(g.platform===`win32`)return!0;try{let{stdout:i}=await r.getExecOutput(`file`,[e],{silent:!0}),a=(t===`.zip`?[`Zip archive`,`ZIP`]:[`gzip`,`tar`,`compressed`]).some(e=>i.includes(e));return a||n.warning(`Download validation failed`,{output:i.trim()}),a}catch{return n.debug(`Could not validate download (file command unavailable)`),!0}}async function q(e,t,n,r,i=U){let a=W(),o=n.find(H,e,a.arch);if(o.length>0)return t.info(`OpenCode found in cache`,{version:e,path:o}),{path:o,version:e,cached:!0};try{return await J(e,a,t,n,r)}catch(n){t.warning(`Primary version install failed, trying fallback`,{requestedVersion:e,fallbackVersion:i,error:n instanceof Error?n.message:String(n)})}if(e!==i)try{let e=await J(i,a,t,n,r);return t.info(`Installed fallback version`,{version:i}),e}catch(t){throw Error(`Failed to install OpenCode (tried ${e} and ${i}): ${t instanceof Error?t.message:String(t)}`)}throw Error(`Failed to install OpenCode version ${e}`)}async function J(e,t,n,r,i){n.info(`Downloading OpenCode`,{version:e});let a=G(e,t),o=await r.downloadTool(a);if(!await K(o,t.ext,n,i))throw Error(`Downloaded archive appears corrupted`);n.info(`Extracting OpenCode`);let s=t.ext===`.zip`?await r.extractZip(o):await r.extractTar(o);n.info(`Caching OpenCode`);let c=await r.cacheDir(s,H,e,t.arch);return n.info(`OpenCode installed`,{version:e,path:c}),{path:c,version:e,cached:!1}}async function Y(e){let t=await fetch(`https://api.github.com/repos/anomalyco/opencode/releases/latest`);if(!t.ok)throw Error(`Failed to fetch latest OpenCode version: ${t.statusText}`);let n=(await t.json()).tag_name.replace(/^v/,``);return e.info(`Latest OpenCode version`,{version:n}),n}function X(){return{find:T.find,downloadTool:T.downloadTool,extractTar:T.extractTar,extractZip:T.extractZip,cacheDir:T.cacheDir}}function Z(){return{exec:O.exec,getExecOutput:O.getExecOutput}}function Q(){return{opencodeVersion:D.getInput(`opencode-version`)||`latest`,authJson:D.getInput(`auth-json`,{required:!0}),appId:D.getInput(`app-id`)||null,privateKey:D.getInput(`private-key`)||null,opencodeConfig:D.getInput(`opencode-config`)||null}}async function $(){let e=Date.now(),t=a({component:`setup`}),n=X(),r=Z();try{let i=Q(),a=D.getInput(`github-token`,{required:!0});t.info(`Starting setup`,{version:i.opencodeVersion});let o;try{o=k(i.authJson)}catch(e){return D.setFailed(`Invalid auth-json: ${e instanceof Error?e.message:String(e)}`),null}let s=i.opencodeVersion;if(s===`latest`)try{s=await Y(t)}catch(e){t.warning(`Failed to get latest version, using fallback`,{error:e instanceof Error?e.message:String(e)}),s=U}let c;try{c=await q(s,t,n,r)}catch(e){return D.setFailed(`Failed to install OpenCode: ${e instanceof Error?e.message:String(e)}`),null}D.addPath(c.path),D.setOutput(`opencode-path`,c.path),D.setOutput(`opencode-version`,c.version),t.info(`OpenCode installed`,{version:c.version,cached:c.cached});let u=await V({logger:t,execAdapter:r,toolCache:n,addPath:D.addPath},{claude:`no`,chatgpt:`no`,gemini:`no`});u.installed?t.info(`oMo installed`,{version:u.version}):D.warning(`oMo installation failed (continuing without it): ${u.error??`unknown error`}`);let f=await j(null,a,t,r);D.exportVariable(`GH_TOKEN`,a),t.info(`GitHub CLI configured`),await N(f.botLogin?.replace(/\[bot\]$/,``)??null,null,t,r),t.info(`Git identity configured`,{user:f.botLogin??`fro-bot[bot]`});let h=x(p(),`opencode`),_=await A(o,h,t);D.setOutput(`auth-json-path`,_),t.info(`auth.json populated`,{path:_});let v=g.env.GITHUB_REPOSITORY??`unknown/unknown`,y=g.env.GITHUB_REF_NAME??`main`,b=d(),S=l({agentIdentity:`github`,repo:v,ref:y,os:b}),C=m({agentIdentity:`github`,repo:v,ref:y,os:b}),w=`miss`;try{let e=await E.restoreCache([h],S,[...C]);e==null?t.info(`No cache found`):(w=`hit`,t.info(`Cache restored`,{key:e}))}catch(e){w=`corrupted`,t.warning(`Cache restore failed`,{error:e instanceof Error?e.message:String(e)})}D.setOutput(`cache-status`,w),D.setOutput(`storage-path`,h);let T=Date.now()-e,O={opencodePath:c.path,opencodeVersion:c.version,ghAuthenticated:f.authenticated,omoInstalled:u.installed,omoError:u.error,cacheStatus:w,duration:T};return t.info(`Setup complete`,{duration:T}),O}catch(e){let n=e instanceof Error?e.message:String(e);return t.error(`Setup failed`,{error:n}),D.setFailed(n),null}}await $();export{};