import{A as e,F as t,I as n,M as r,N as i,P as a,_ as o,c as s,d as c,f as l,g as u,h as d,j as f,m as p,o as m,s as h,u as g,v as _}from"./env-CMc5SUgh.js";import v from"node:process";import*as y from"node:fs/promises";import b from"node:fs/promises";import*as x from"node:path";import S,{join as C}from"node:path";import w from"node:os";var T=a(((e,n)=>{var r=e&&e.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),i=e&&e.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),a=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!==`default`&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},o=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(e,`__esModule`,{value:!0}),e._readLinuxVersionFile=e._getOsVersion=e._findMatch=void 0;let s=a(d()),c=u(),l=t(`os`),f=t(`child_process`),p=t(`fs`);function m(e,t,r,i){return o(this,void 0,void 0,function*(){let a=l.platform(),o,u,d;for(let o of r){let r=o.version;if((0,c.debug)(`check ${r} satisfies ${e}`),s.satisfies(r,e)&&(!t||o.stable===t)&&(d=o.files.find(e=>{(0,c.debug)(`${e.arch}===${i} && ${e.platform}===${a}`);let t=e.arch===i&&e.platform===a;if(t&&e.platform_version){let r=n.exports._getOsVersion();t=r===e.platform_version?!0:s.satisfies(r,e.platform_version)}return t}),d)){(0,c.debug)(`matched ${o.version}`),u=o;break}}return u&&d&&(o=Object.assign({},u),o.files=[d]),o})}e._findMatch=m;function h(){let e=l.platform(),t=``;if(e===`darwin`)t=f.execSync(`sw_vers -productVersion`).toString();else if(e===`linux`){let e=n.exports._readLinuxVersionFile();if(e){let n=e.split(`
`);for(let e of n){let n=e.split(`=`);if(n.length===2&&(n[0].trim()===`VERSION_ID`||n[0].trim()===`DISTRIB_RELEASE`)){t=n[1].trim().replace(/^"/,``).replace(/"$/,``);break}}}}return t}e._getOsVersion=h;function g(){let e=`/etc/lsb-release`,t=`/etc/os-release`,n=``;return p.existsSync(e)?n=p.readFileSync(e).toString():p.existsSync(t)&&(n=p.readFileSync(t).toString()),n}e._readLinuxVersionFile=g})),E=a((e=>{var t=e&&e.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),n=e&&e.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),r=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var i in e)i!==`default`&&Object.prototype.hasOwnProperty.call(e,i)&&t(r,e,i);return n(r,e),r},i=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(e,`__esModule`,{value:!0}),e.RetryHelper=void 0;let a=r(u());e.RetryHelper=class{constructor(e,t,n){if(e<1)throw Error(`max attempts should be greater than or equal to 1`);if(this.maxAttempts=e,this.minSeconds=Math.floor(t),this.maxSeconds=Math.floor(n),this.minSeconds>this.maxSeconds)throw Error(`min seconds should be less than or equal to max seconds`)}execute(e,t){return i(this,void 0,void 0,function*(){let n=1;for(;n<this.maxAttempts;){try{return yield e()}catch(e){if(t&&!t(e))throw e;a.info(e.message)}let r=this.getSleepAmount();a.info(`Waiting ${r} seconds before trying again`),yield this.sleep(r),n++}return yield e()})}getSleepAmount(){return Math.floor(Math.random()*(this.maxSeconds-this.minSeconds+1))+this.minSeconds}sleep(e){return i(this,void 0,void 0,function*(){return new Promise(t=>setTimeout(t,e*1e3))})}}})),D=n(a((e=>{var n=e&&e.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),r=e&&e.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),i=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var i in e)i!==`default`&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return r(t,e),t},a=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(e,`__esModule`,{value:!0}),e.evaluateVersions=e.isExplicitVersion=e.findFromManifest=e.getManifestFromRepo=e.findAllVersions=e.find=e.cacheFile=e.cacheDir=e.extractZip=e.extractXar=e.extractTar=e.extract7z=e.downloadTool=e.HTTPError=void 0;let s=i(u()),c=i(_()),l=i(t(`crypto`)),p=i(t(`fs`)),m=i(T()),h=i(t(`os`)),g=i(t(`path`)),v=i(f()),y=i(d()),b=i(t(`stream`)),x=i(t(`util`)),S=t(`assert`),C=o(),w=E();var D=class extends Error{constructor(e){super(`Unexpected HTTP response: ${e}`),this.httpStatusCode=e,Object.setPrototypeOf(this,new.target.prototype)}};e.HTTPError=D;let O=process.platform===`win32`,k=process.platform===`darwin`;function A(e,t,n,r){return a(this,void 0,void 0,function*(){t||=g.join(X(),l.randomUUID()),yield c.mkdirP(g.dirname(t)),s.debug(`Downloading ${e}`),s.debug(`Destination ${t}`);let i=Z(`TEST_DOWNLOAD_TOOL_RETRY_MIN_SECONDS`,10),o=Z(`TEST_DOWNLOAD_TOOL_RETRY_MAX_SECONDS`,20);return yield new w.RetryHelper(3,i,o).execute(()=>a(this,void 0,void 0,function*(){return yield j(e,t||``,n,r)}),e=>!(e instanceof D&&e.httpStatusCode&&e.httpStatusCode<500&&e.httpStatusCode!==408&&e.httpStatusCode!==429))})}e.downloadTool=A;function j(e,t,n,r){return a(this,void 0,void 0,function*(){if(p.existsSync(t))throw Error(`Destination file path ${t} already exists`);let i=new v.HttpClient(`actions/tool-cache`,[],{allowRetries:!1});n&&(s.debug(`set auth`),r===void 0&&(r={}),r.authorization=n);let a=yield i.get(e,r);if(a.message.statusCode!==200){let t=new D(a.message.statusCode);throw s.debug(`Failed to download from "${e}". Code(${a.message.statusCode}) Message(${a.message.statusMessage})`),t}let o=x.promisify(b.pipeline),l=Z(`TEST_DOWNLOAD_TOOL_RESPONSE_MESSAGE_FACTORY`,()=>a.message)(),u=!1;try{return yield o(l,p.createWriteStream(t)),s.debug(`download complete`),u=!0,t}finally{if(!u){s.debug(`download failed`);try{yield c.rmRF(t)}catch(e){s.debug(`Failed to delete '${t}'. ${e.message}`)}}}})}function M(e,t,n){return a(this,void 0,void 0,function*(){(0,S.ok)(O,`extract7z() not supported on current OS`),(0,S.ok)(e,`parameter "file" is required`),t=yield W(t);let r=process.cwd();if(process.chdir(t),n)try{let t=[`x`,s.isDebug()?`-bb1`:`-bb0`,`-bd`,`-sccUTF-8`,e];yield(0,C.exec)(`"${n}"`,t,{silent:!0})}finally{process.chdir(r)}else{let n=[`-NoLogo`,`-Sta`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,`& '${g.join(__dirname,`..`,`scripts`,`Invoke-7zdec.ps1`).replace(/'/g,`''`).replace(/"|\n|\r/g,``)}' -Source '${e.replace(/'/g,`''`).replace(/"|\n|\r/g,``)}' -Target '${t.replace(/'/g,`''`).replace(/"|\n|\r/g,``)}'`],i={silent:!0};try{let e=yield c.which(`powershell`,!0);yield(0,C.exec)(`"${e}"`,n,i)}finally{process.chdir(r)}}return t})}e.extract7z=M;function N(e,t,n=`xz`){return a(this,void 0,void 0,function*(){if(!e)throw Error(`parameter 'file' is required`);t=yield W(t),s.debug(`Checking tar --version`);let r=``;yield(0,C.exec)(`tar --version`,[],{ignoreReturnCode:!0,silent:!0,listeners:{stdout:e=>r+=e.toString(),stderr:e=>r+=e.toString()}}),s.debug(r.trim());let i=r.toUpperCase().includes(`GNU TAR`),a;a=n instanceof Array?n:[n],s.isDebug()&&!n.includes(`v`)&&a.push(`-v`);let o=t,c=e;return O&&i&&(a.push(`--force-local`),o=t.replace(/\\/g,`/`),c=e.replace(/\\/g,`/`)),i&&(a.push(`--warning=no-unknown-keyword`),a.push(`--overwrite`)),a.push(`-C`,o,`-f`,c),yield(0,C.exec)(`tar`,a),t})}e.extractTar=N;function P(e,t,n=[]){return a(this,void 0,void 0,function*(){(0,S.ok)(k,`extractXar() not supported on current OS`),(0,S.ok)(e,`parameter "file" is required`),t=yield W(t);let r;r=n instanceof Array?n:[n],r.push(`-x`,`-C`,t,`-f`,e),s.isDebug()&&r.push(`-v`);let i=yield c.which(`xar`,!0);return yield(0,C.exec)(`"${i}"`,Q(r)),t})}e.extractXar=P;function F(e,t){return a(this,void 0,void 0,function*(){if(!e)throw Error(`parameter 'file' is required`);return t=yield W(t),O?yield I(e,t):yield L(e,t),t})}e.extractZip=F;function I(e,t){return a(this,void 0,void 0,function*(){let n=e.replace(/'/g,`''`).replace(/"|\n|\r/g,``),r=t.replace(/'/g,`''`).replace(/"|\n|\r/g,``),i=yield c.which(`pwsh`,!1);if(i){let e=[`-NoLogo`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,[`$ErrorActionPreference = 'Stop' ;`,`try { Add-Type -AssemblyName System.IO.Compression.ZipFile } catch { } ;`,`try { [System.IO.Compression.ZipFile]::ExtractToDirectory('${n}', '${r}', $true) }`,`catch { if (($_.Exception.GetType().FullName -eq 'System.Management.Automation.MethodException') -or ($_.Exception.GetType().FullName -eq 'System.Management.Automation.RuntimeException') ){ Expand-Archive -LiteralPath '${n}' -DestinationPath '${r}' -Force } else { throw $_ } } ;`].join(` `)];s.debug(`Using pwsh at path: ${i}`),yield(0,C.exec)(`"${i}"`,e)}else{let e=[`-NoLogo`,`-Sta`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,[`$ErrorActionPreference = 'Stop' ;`,`try { Add-Type -AssemblyName System.IO.Compression.FileSystem } catch { } ;`,`if ((Get-Command -Name Expand-Archive -Module Microsoft.PowerShell.Archive -ErrorAction Ignore)) { Expand-Archive -LiteralPath '${n}' -DestinationPath '${r}' -Force }`,`else {[System.IO.Compression.ZipFile]::ExtractToDirectory('${n}', '${r}', $true) }`].join(` `)],t=yield c.which(`powershell`,!0);s.debug(`Using powershell at path: ${t}`),yield(0,C.exec)(`"${t}"`,e)}})}function L(e,t){return a(this,void 0,void 0,function*(){let n=yield c.which(`unzip`,!0),r=[e];s.isDebug()||r.unshift(`-q`),r.unshift(`-o`),yield(0,C.exec)(`"${n}"`,r,{cwd:t})})}function R(e,t,n,r){return a(this,void 0,void 0,function*(){if(n=y.clean(n)||n,r||=h.arch(),s.debug(`Caching tool ${t} ${n} ${r}`),s.debug(`source dir: ${e}`),!p.statSync(e).isDirectory())throw Error(`sourceDir is not a directory`);let i=yield G(t,n,r);for(let t of p.readdirSync(e)){let n=g.join(e,t);yield c.cp(n,i,{recursive:!0})}return K(t,n,r),i})}e.cacheDir=R;function z(e,t,n,r,i){return a(this,void 0,void 0,function*(){if(r=y.clean(r)||r,i||=h.arch(),s.debug(`Caching tool ${n} ${r} ${i}`),s.debug(`source file: ${e}`),!p.statSync(e).isFile())throw Error(`sourceFile is not a file`);let a=yield G(n,r,i),o=g.join(a,t);return s.debug(`destination file ${o}`),yield c.cp(e,o),K(n,r,i),a})}e.cacheFile=z;function B(e,t,n){if(!e)throw Error(`toolName parameter is required`);if(!t)throw Error(`versionSpec parameter is required`);n||=h.arch(),q(t)||(t=J(V(e,n),t));let r=``;if(t){t=y.clean(t)||``;let i=g.join(Y(),e,t,n);s.debug(`checking cache: ${i}`),p.existsSync(i)&&p.existsSync(`${i}.complete`)?(s.debug(`Found tool in cache ${e} ${t} ${n}`),r=i):s.debug(`not found`)}return r}e.find=B;function V(e,t){let n=[];t||=h.arch();let r=g.join(Y(),e);if(p.existsSync(r)){let e=p.readdirSync(r);for(let i of e)if(q(i)){let e=g.join(r,i,t||``);p.existsSync(e)&&p.existsSync(`${e}.complete`)&&n.push(i)}}return n}e.findAllVersions=V;function H(e,t,n,r=`master`){return a(this,void 0,void 0,function*(){let i=[],a=`https://api.github.com/repos/${e}/${t}/git/trees/${r}`,o=new v.HttpClient(`tool-cache`),c={};n&&(s.debug(`set auth`),c.authorization=n);let l=yield o.getJson(a,c);if(!l.result)return i;let u=``;for(let e of l.result.tree)if(e.path===`versions-manifest.json`){u=e.url;break}c.accept=`application/vnd.github.VERSION.raw`;let d=yield(yield o.get(u,c)).readBody();if(d){d=d.replace(/^\uFEFF/,``);try{i=JSON.parse(d)}catch{s.debug(`Invalid json`)}}return i})}e.getManifestFromRepo=H;function U(e,t,n,r=h.arch()){return a(this,void 0,void 0,function*(){return yield m._findMatch(e,t,n,r)})}e.findFromManifest=U;function W(e){return a(this,void 0,void 0,function*(){return e||=g.join(X(),l.randomUUID()),yield c.mkdirP(e),e})}function G(e,t,n){return a(this,void 0,void 0,function*(){let r=g.join(Y(),e,y.clean(t)||t,n||``);s.debug(`destination ${r}`);let i=`${r}.complete`;return yield c.rmRF(r),yield c.rmRF(i),yield c.mkdirP(r),r})}function K(e,t,n){let r=`${g.join(Y(),e,y.clean(t)||t,n||``)}.complete`;p.writeFileSync(r,``),s.debug(`finished caching tool`)}function q(e){let t=y.clean(e)||``;s.debug(`isExplicit: ${t}`);let n=y.valid(t)!=null;return s.debug(`explicit? ${n}`),n}e.isExplicitVersion=q;function J(e,t){let n=``;s.debug(`evaluating ${e.length} versions`),e=e.sort((e,t)=>y.gt(e,t)?1:-1);for(let r=e.length-1;r>=0;r--){let i=e[r];if(y.satisfies(i,t)){n=i;break}}return n?s.debug(`matched: ${n}`):s.debug(`match not found`),n}e.evaluateVersions=J;function Y(){let e=process.env.RUNNER_TOOL_CACHE||``;return(0,S.ok)(e,`Expected RUNNER_TOOL_CACHE to be defined`),e}function X(){let e=process.env.RUNNER_TEMP||``;return(0,S.ok)(e,`Expected RUNNER_TEMP to be defined`),e}function Z(e,t){let n=global[e];return n===void 0?t:n}function Q(e){return Array.from(new Set(e))}}))()),O=n(p()),k=n(e()),A=n(r()),j=n(i());function M(e){let t;try{t=JSON.parse(e)}catch(e){throw e instanceof SyntaxError?Error(`Invalid auth-json format: ${e.message}`):e}if(typeof t!=`object`||!t||Array.isArray(t))throw Error(`auth-json must be a JSON object`);return t}async function N(e,t,n){let r=x.join(t,`auth.json`);await y.mkdir(t,{recursive:!0});let i=JSON.stringify(e,null,2);return await y.writeFile(r,i,{mode:384}),n.info(`Populated auth.json`,{path:r,providers:Object.keys(e).length}),r}async function P(e,t,n,r){let i=t??n,a=t==null?n.length>0?`github-token`:`none`:`app-token`;if(i.length===0)return r.warning(`No GitHub token available`),{authenticated:!1,method:`none`,botLogin:null};v.env.GH_TOKEN=i,r.info(`Configured authentication`,{method:a});let o=null;return e!=null&&(o=await g(e,r)),{authenticated:!0,method:a,botLogin:o}}async function F(e,t,n,r){let i=e==null?`fro-bot[bot]`:`${e}[bot]`,a=t!=null&&e!=null?`${t}+${e}[bot]@users.noreply.github.com`:`agent@fro.bot`;await r.exec(`git`,[`config`,`--global`,`user.name`,i],void 0),await r.exec(`git`,[`config`,`--global`,`user.email`,a],void 0),n.info(`Configured git identity`,{name:i,email:a})}function I(){let e=w.platform(),t=w.arch();return{os:{darwin:`darwin`,linux:`linux`,win32:`windows`}[e]??`linux`,arch:{arm64:`aarch64`,x64:`x64`}[t]??`x64`,ext:`.zip`}}function L(e,t){return`https://github.com/oven-sh/bun/releases/download/bun-${e.startsWith(`v`)?e:`v${e}`}/${`bun-${t.os}-${t.arch}${t.ext}`}`}async function R(e,t,n,r,i=`1.3.5`){let a=I(),o=t.find(`bun`,i,a.arch);if(o.length>0)return e.info(`Bun found in cache`,{version:i,path:o}),r(o),await B(o),{path:o,version:i,cached:!0};e.info(`Downloading Bun`,{version:i});let s=L(i,a);try{let o=await t.downloadTool(s);if(v.platform!==`win32`&&!await V(o,e,n))throw Error(`Downloaded Bun archive appears corrupted`);e.info(`Extracting Bun`);let c=await z(await t.extractZip(o),t),l=S.dirname(c);e.info(`Caching Bun`);let u=await t.cacheDir(l,`bun`,i,a.arch);return r(u),await B(u),e.info(`Bun installed`,{version:i,path:u}),{path:u,version:i,cached:!1}}catch(e){let t=e instanceof Error?e.message:String(e);throw Error(`Failed to install Bun ${i}: ${t}`)}}async function z(e,t){for(let n of await b.readdir(e,{withFileTypes:!0})){let{name:r}=n,i=S.join(e,r);if(n.isFile()){if(r===`bun`||r===`bun.exe`)return i;if(/^bun.*\.zip/.test(r))return z(await t.extractZip(i),t)}if(r.startsWith(`bun`)&&n.isDirectory())return z(i,t)}throw Error(`Could not find executable: bun`)}async function B(e){let t=e=>v.platform===`win32`?`${e}.exe`:e,n=S.join(e,t(`bun`));try{await b.symlink(n,S.join(e,t(`bunx`)))}catch(e){if(typeof e!=`object`||e.code!==`EEXIST`)throw e}}async function V(e,t,n){try{let{stdout:r}=await n.getExecOutput(`file`,[e],{silent:!0}),i=r.includes(`Zip archive`)||r.includes(`ZIP`);return i||t.warning(`Bun download validation failed`,{output:r.trim()}),i}catch{return t.debug(`Could not validate Bun download (file command unavailable)`),!0}}async function H(e){try{let{exitCode:t}=await e.getExecOutput(`bun`,[`--version`],{silent:!0,ignoreReturnCode:!0});return t===0}catch{return!1}}async function U(e,t={}){let{logger:n,execAdapter:r,toolCache:i,addPath:a}=e,{claude:o=`no`,chatgpt:s=`no`,gemini:c=`no`}=t;if(n.info(`Installing Oh My OpenCode plugin`,{claude:o,chatgpt:s,gemini:c}),!await H(r)){n.info(`Bun not found, installing...`);try{await R(n,i,r,a)}catch(e){let t=e instanceof Error?e.message:String(e);return n.error(`Failed to install Bun runtime`,{error:t}),{installed:!1,version:null,error:`Bun installation failed: ${t}`}}}let l=[`oh-my-opencode`,`install`,`--no-tui`,`--claude=${o}`,`--chatgpt=${s}`,`--gemini=${c}`];try{let e=``,t=await r.exec(`bunx`,l,{listeners:{stdout:t=>{e+=t.toString()},stderr:t=>{e+=t.toString()}},silent:!0});if(t!==0){let r=`oMo installation returned exit code ${t}`;return n.warning(r,{output:e.slice(0,500)}),{installed:!1,version:null,error:r}}let i=/oh-my-opencode@(\d+\.\d+\.\d+)/i.exec(e),a=i!=null&&i[1]!=null?i[1]:null;return n.info(`oMo plugin installed`,{version:a}),{installed:!0,version:a,error:null}}catch(e){let t=e instanceof Error?e.message:String(e);return n.error(`Failed to install oMo plugin`,{error:t}),{installed:!1,version:null,error:t}}}const W=`opencode`,G=`1.1.1`;function K(){let e=w.platform(),t=w.arch(),n={darwin:`darwin`,linux:`linux`,win32:`windows`},r={x64:`x64`,arm64:`arm64`},i=e===`win32`||e===`darwin`?`.zip`:`.tar.gz`;return{os:n[e]??`linux`,arch:r[t]??`x64`,ext:i}}function q(e,t){return`https://github.com/anomalyco/opencode/releases/download/${e.startsWith(`v`)?e:`v${e}`}/${`opencode-${t.os}-${t.arch}${t.ext}`}`}async function J(e,t,n,r){if(v.platform===`win32`)return!0;try{let{stdout:i}=await r.getExecOutput(`file`,[e],{silent:!0}),a=(t===`.zip`?[`Zip archive`,`ZIP`]:[`gzip`,`tar`,`compressed`]).some(e=>i.includes(e));return a||n.warning(`Download validation failed`,{output:i.trim()}),a}catch{return n.debug(`Could not validate download (file command unavailable)`),!0}}async function Y(e,t,n,r,i=G){let a=K(),o=n.find(W,e,a.arch);if(o.length>0)return t.info(`OpenCode found in cache`,{version:e,path:o}),{path:o,version:e,cached:!0};try{return await X(e,a,t,n,r)}catch(n){t.warning(`Primary version install failed, trying fallback`,{requestedVersion:e,fallbackVersion:i,error:n instanceof Error?n.message:String(n)})}if(e!==i)try{let e=await X(i,a,t,n,r);return t.info(`Installed fallback version`,{version:i}),e}catch(t){throw Error(`Failed to install OpenCode (tried ${e} and ${i}): ${t instanceof Error?t.message:String(t)}`)}throw Error(`Failed to install OpenCode version ${e}`)}async function X(e,t,n,r,i){n.info(`Downloading OpenCode`,{version:e});let a=q(e,t),o=await r.downloadTool(a);if(!await J(o,t.ext,n,i))throw Error(`Downloaded archive appears corrupted`);n.info(`Extracting OpenCode`);let s=t.ext===`.zip`?await r.extractZip(o):await r.extractTar(o);n.info(`Caching OpenCode`);let c=await r.cacheDir(s,W,e,t.arch);return n.info(`OpenCode installed`,{version:e,path:c}),{path:c,version:e,cached:!1}}async function Z(e){let t=await fetch(`https://api.github.com/repos/anomalyco/opencode/releases/latest`);if(!t.ok)throw Error(`Failed to fetch latest OpenCode version: ${t.statusText}`);let n=(await t.json()).tag_name.replace(/^v/,``);return e.info(`Latest OpenCode version`,{version:n}),n}function Q(){return{find:D.find,downloadTool:D.downloadTool,extractTar:D.extractTar,extractZip:D.extractZip,cacheDir:D.cacheDir}}function $(){return{exec:j.exec,getExecOutput:j.getExecOutput}}function ee(){return{opencodeVersion:A.getInput(`opencode-version`)||`latest`,authJson:A.getInput(`auth-json`,{required:!0}),appId:A.getInput(`app-id`)||null,privateKey:A.getInput(`private-key`)||null,opencodeConfig:A.getInput(`opencode-config`)||null}}async function te(){let e=Date.now(),t=s({component:`setup`}),n=Q(),r=$();try{let i=ee(),a=A.getInput(`github-token`,{required:!0});t.info(`Starting setup`,{version:i.opencodeVersion});let o;try{o=M(i.authJson)}catch(e){return A.setFailed(`Invalid auth-json: ${e instanceof Error?e.message:String(e)}`),null}let s=i.opencodeVersion;if(s===`latest`)try{s=await Z(t)}catch(e){t.warning(`Failed to get latest version, using fallback`,{error:e instanceof Error?e.message:String(e)}),s=G}let u;try{u=await Y(s,t,n,r)}catch(e){return A.setFailed(`Failed to install OpenCode: ${e instanceof Error?e.message:String(e)}`),null}A.addPath(u.path),A.setOutput(`opencode-path`,u.path),A.setOutput(`opencode-version`,u.version),t.info(`OpenCode installed`,{version:u.version,cached:u.cached});let d=await U({logger:t,execAdapter:r,toolCache:n,addPath:A.addPath},{claude:`no`,chatgpt:`no`,gemini:`no`});d.installed?t.info(`oMo installed`,{version:d.version}):A.warning(`oMo installation failed (continuing without it): ${d.error??`unknown error`}`);let f=await P((0,k.getOctokit)(a),null,a,t);A.exportVariable(`GH_TOKEN`,a),t.info(`GitHub CLI configured`),await F(f.botLogin?.replace(/\[bot\]$/,``)??null,null,t,r),t.info(`Git identity configured`,{user:f.botLogin??`fro-bot[bot]`});let p=C(h(),`opencode`),g=await N(o,p,t);A.setOutput(`auth-json-path`,g),t.info(`auth.json populated`,{path:g});let _=v.env.GITHUB_REPOSITORY??`unknown/unknown`,y=v.env.GITHUB_REF_NAME??`main`,b=m(),x=c({agentIdentity:`github`,repo:_,ref:y,os:b}),S=l({agentIdentity:`github`,repo:_,ref:y,os:b}),w=`miss`;try{let e=await O.restoreCache([p],x,[...S]);e==null?t.info(`No cache found`):(w=`hit`,t.info(`Cache restored`,{key:e}))}catch(e){w=`corrupted`,t.warning(`Cache restore failed`,{error:e instanceof Error?e.message:String(e)})}A.setOutput(`cache-status`,w),A.setOutput(`storage-path`,p);let T=Date.now()-e,E={opencodePath:u.path,opencodeVersion:u.version,ghAuthenticated:f.authenticated,omoInstalled:d.installed,omoError:d.error,cacheStatus:w,duration:T};return t.info(`Setup complete`,{duration:T}),E}catch(e){let n=e instanceof Error?e.message:String(e);return t.error(`Setup failed`,{error:n}),A.setFailed(n),null}}await te();export{};