import{C as e,S as t,_ as n,b as r,c as i,g as a,h as o,l as s,m as c,o as l,s as u,u as d,v as f,w as p,y as m}from"./env-W3bsYML5.js";import h from"node:process";import*as g from"node:fs/promises";import*as _ from"node:path";import v,{join as y}from"node:path";import b from"node:os";var x=t(((t,n)=>{var r=t&&t.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),i=t&&t.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),s=t&&t.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!==`default`&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},c=t&&t.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,`__esModule`,{value:!0}),t._readLinuxVersionFile=t._getOsVersion=t._findMatch=void 0;let l=s(o()),u=a(),d=e(`os`),f=e(`child_process`),p=e(`fs`);function m(e,t,r,i){return c(this,void 0,void 0,function*(){let a=d.platform(),o,s,c;for(let o of r){let r=o.version;if((0,u.debug)(`check ${r} satisfies ${e}`),l.satisfies(r,e)&&(!t||o.stable===t)&&(c=o.files.find(e=>{(0,u.debug)(`${e.arch}===${i} && ${e.platform}===${a}`);let t=e.arch===i&&e.platform===a;if(t&&e.platform_version){let r=n.exports._getOsVersion();t=r===e.platform_version?!0:l.satisfies(r,e.platform_version)}return t}),c)){(0,u.debug)(`matched ${o.version}`),s=o;break}}return s&&c&&(o=Object.assign({},s),o.files=[c]),o})}t._findMatch=m;function h(){let e=d.platform(),t=``;if(e===`darwin`)t=f.execSync(`sw_vers -productVersion`).toString();else if(e===`linux`){let e=n.exports._readLinuxVersionFile();if(e){let n=e.split(`
`);for(let e of n){let n=e.split(`=`);if(n.length===2&&(n[0].trim()===`VERSION_ID`||n[0].trim()===`DISTRIB_RELEASE`)){t=n[1].trim().replace(/^"/,``).replace(/"$/,``);break}}}}return t}t._getOsVersion=h;function g(){let e=`/etc/lsb-release`,t=`/etc/os-release`,n=``;return p.existsSync(e)?n=p.readFileSync(e).toString():p.existsSync(t)&&(n=p.readFileSync(t).toString()),n}t._readLinuxVersionFile=g})),S=t((e=>{var t=e&&e.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),n=e&&e.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),r=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var i in e)i!==`default`&&Object.prototype.hasOwnProperty.call(e,i)&&t(r,e,i);return n(r,e),r},i=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(e,`__esModule`,{value:!0}),e.RetryHelper=void 0;let o=r(a());e.RetryHelper=class{constructor(e,t,n){if(e<1)throw Error(`max attempts should be greater than or equal to 1`);if(this.maxAttempts=e,this.minSeconds=Math.floor(t),this.maxSeconds=Math.floor(n),this.minSeconds>this.maxSeconds)throw Error(`min seconds should be less than or equal to max seconds`)}execute(e,t){return i(this,void 0,void 0,function*(){let n=1;for(;n<this.maxAttempts;){try{return yield e()}catch(e){if(t&&!t(e))throw e;o.info(e.message)}let r=this.getSleepAmount();o.info(`Waiting ${r} seconds before trying again`),yield this.sleep(r),n++}return yield e()})}getSleepAmount(){return Math.floor(Math.random()*(this.maxSeconds-this.minSeconds+1))+this.minSeconds}sleep(e){return i(this,void 0,void 0,function*(){return new Promise(t=>setTimeout(t,e*1e3))})}}})),C=p(t((t=>{var r=t&&t.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),i=t&&t.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),s=t&&t.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!==`default`&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},c=t&&t.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,`__esModule`,{value:!0}),t.evaluateVersions=t.isExplicitVersion=t.findFromManifest=t.getManifestFromRepo=t.findAllVersions=t.find=t.cacheFile=t.cacheDir=t.extractZip=t.extractXar=t.extractTar=t.extract7z=t.downloadTool=t.HTTPError=void 0;let l=s(a()),u=s(n()),d=s(e(`crypto`)),p=s(e(`fs`)),m=s(x()),h=s(e(`os`)),g=s(e(`path`)),_=s(f()),v=s(o()),y=s(e(`stream`)),b=s(e(`util`)),C=e(`assert`),w=e(`@actions/exec/lib/exec`),T=S();var E=class extends Error{constructor(e){super(`Unexpected HTTP response: ${e}`),this.httpStatusCode=e,Object.setPrototypeOf(this,new.target.prototype)}};t.HTTPError=E;let D=process.platform===`win32`,O=process.platform===`darwin`;function k(e,t,n,r){return c(this,void 0,void 0,function*(){t||=g.join(Y(),d.randomUUID()),yield u.mkdirP(g.dirname(t)),l.debug(`Downloading ${e}`),l.debug(`Destination ${t}`);let i=X(`TEST_DOWNLOAD_TOOL_RETRY_MIN_SECONDS`,10),a=X(`TEST_DOWNLOAD_TOOL_RETRY_MAX_SECONDS`,20);return yield new T.RetryHelper(3,i,a).execute(()=>c(this,void 0,void 0,function*(){return yield A(e,t||``,n,r)}),e=>!(e instanceof E&&e.httpStatusCode&&e.httpStatusCode<500&&e.httpStatusCode!==408&&e.httpStatusCode!==429))})}t.downloadTool=k;function A(e,t,n,r){return c(this,void 0,void 0,function*(){if(p.existsSync(t))throw Error(`Destination file path ${t} already exists`);let i=new _.HttpClient(`actions/tool-cache`,[],{allowRetries:!1});n&&(l.debug(`set auth`),r===void 0&&(r={}),r.authorization=n);let a=yield i.get(e,r);if(a.message.statusCode!==200){let t=new E(a.message.statusCode);throw l.debug(`Failed to download from "${e}". Code(${a.message.statusCode}) Message(${a.message.statusMessage})`),t}let o=b.promisify(y.pipeline),s=X(`TEST_DOWNLOAD_TOOL_RESPONSE_MESSAGE_FACTORY`,()=>a.message)(),c=!1;try{return yield o(s,p.createWriteStream(t)),l.debug(`download complete`),c=!0,t}finally{if(!c){l.debug(`download failed`);try{yield u.rmRF(t)}catch(e){l.debug(`Failed to delete '${t}'. ${e.message}`)}}}})}function j(e,t,n){return c(this,void 0,void 0,function*(){(0,C.ok)(D,`extract7z() not supported on current OS`),(0,C.ok)(e,`parameter "file" is required`),t=yield U(t);let r=process.cwd();if(process.chdir(t),n)try{let t=[`x`,l.isDebug()?`-bb1`:`-bb0`,`-bd`,`-sccUTF-8`,e];yield(0,w.exec)(`"${n}"`,t,{silent:!0})}finally{process.chdir(r)}else{let n=[`-NoLogo`,`-Sta`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,`& '${g.join(__dirname,`..`,`scripts`,`Invoke-7zdec.ps1`).replace(/'/g,`''`).replace(/"|\n|\r/g,``)}' -Source '${e.replace(/'/g,`''`).replace(/"|\n|\r/g,``)}' -Target '${t.replace(/'/g,`''`).replace(/"|\n|\r/g,``)}'`],i={silent:!0};try{let e=yield u.which(`powershell`,!0);yield(0,w.exec)(`"${e}"`,n,i)}finally{process.chdir(r)}}return t})}t.extract7z=j;function M(e,t,n=`xz`){return c(this,void 0,void 0,function*(){if(!e)throw Error(`parameter 'file' is required`);t=yield U(t),l.debug(`Checking tar --version`);let r=``;yield(0,w.exec)(`tar --version`,[],{ignoreReturnCode:!0,silent:!0,listeners:{stdout:e=>r+=e.toString(),stderr:e=>r+=e.toString()}}),l.debug(r.trim());let i=r.toUpperCase().includes(`GNU TAR`),a;a=n instanceof Array?n:[n],l.isDebug()&&!n.includes(`v`)&&a.push(`-v`);let o=t,s=e;return D&&i&&(a.push(`--force-local`),o=t.replace(/\\/g,`/`),s=e.replace(/\\/g,`/`)),i&&(a.push(`--warning=no-unknown-keyword`),a.push(`--overwrite`)),a.push(`-C`,o,`-f`,s),yield(0,w.exec)(`tar`,a),t})}t.extractTar=M;function N(e,t,n=[]){return c(this,void 0,void 0,function*(){(0,C.ok)(O,`extractXar() not supported on current OS`),(0,C.ok)(e,`parameter "file" is required`),t=yield U(t);let r;r=n instanceof Array?n:[n],r.push(`-x`,`-C`,t,`-f`,e),l.isDebug()&&r.push(`-v`);let i=yield u.which(`xar`,!0);return yield(0,w.exec)(`"${i}"`,Z(r)),t})}t.extractXar=N;function P(e,t){return c(this,void 0,void 0,function*(){if(!e)throw Error(`parameter 'file' is required`);return t=yield U(t),D?yield F(e,t):yield I(e,t),t})}t.extractZip=P;function F(e,t){return c(this,void 0,void 0,function*(){let n=e.replace(/'/g,`''`).replace(/"|\n|\r/g,``),r=t.replace(/'/g,`''`).replace(/"|\n|\r/g,``),i=yield u.which(`pwsh`,!1);if(i){let e=[`-NoLogo`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,[`$ErrorActionPreference = 'Stop' ;`,`try { Add-Type -AssemblyName System.IO.Compression.ZipFile } catch { } ;`,`try { [System.IO.Compression.ZipFile]::ExtractToDirectory('${n}', '${r}', $true) }`,`catch { if (($_.Exception.GetType().FullName -eq 'System.Management.Automation.MethodException') -or ($_.Exception.GetType().FullName -eq 'System.Management.Automation.RuntimeException') ){ Expand-Archive -LiteralPath '${n}' -DestinationPath '${r}' -Force } else { throw $_ } } ;`].join(` `)];l.debug(`Using pwsh at path: ${i}`),yield(0,w.exec)(`"${i}"`,e)}else{let e=[`-NoLogo`,`-Sta`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,[`$ErrorActionPreference = 'Stop' ;`,`try { Add-Type -AssemblyName System.IO.Compression.FileSystem } catch { } ;`,`if ((Get-Command -Name Expand-Archive -Module Microsoft.PowerShell.Archive -ErrorAction Ignore)) { Expand-Archive -LiteralPath '${n}' -DestinationPath '${r}' -Force }`,`else {[System.IO.Compression.ZipFile]::ExtractToDirectory('${n}', '${r}', $true) }`].join(` `)],t=yield u.which(`powershell`,!0);l.debug(`Using powershell at path: ${t}`),yield(0,w.exec)(`"${t}"`,e)}})}function I(e,t){return c(this,void 0,void 0,function*(){let n=yield u.which(`unzip`,!0),r=[e];l.isDebug()||r.unshift(`-q`),r.unshift(`-o`),yield(0,w.exec)(`"${n}"`,r,{cwd:t})})}function L(e,t,n,r){return c(this,void 0,void 0,function*(){if(n=v.clean(n)||n,r||=h.arch(),l.debug(`Caching tool ${t} ${n} ${r}`),l.debug(`source dir: ${e}`),!p.statSync(e).isDirectory())throw Error(`sourceDir is not a directory`);let i=yield W(t,n,r);for(let t of p.readdirSync(e)){let n=g.join(e,t);yield u.cp(n,i,{recursive:!0})}return G(t,n,r),i})}t.cacheDir=L;function R(e,t,n,r,i){return c(this,void 0,void 0,function*(){if(r=v.clean(r)||r,i||=h.arch(),l.debug(`Caching tool ${n} ${r} ${i}`),l.debug(`source file: ${e}`),!p.statSync(e).isFile())throw Error(`sourceFile is not a file`);let a=yield W(n,r,i),o=g.join(a,t);return l.debug(`destination file ${o}`),yield u.cp(e,o),G(n,r,i),a})}t.cacheFile=R;function z(e,t,n){if(!e)throw Error(`toolName parameter is required`);if(!t)throw Error(`versionSpec parameter is required`);n||=h.arch(),K(t)||(t=q(B(e,n),t));let r=``;if(t){t=v.clean(t)||``;let i=g.join(J(),e,t,n);l.debug(`checking cache: ${i}`),p.existsSync(i)&&p.existsSync(`${i}.complete`)?(l.debug(`Found tool in cache ${e} ${t} ${n}`),r=i):l.debug(`not found`)}return r}t.find=z;function B(e,t){let n=[];t||=h.arch();let r=g.join(J(),e);if(p.existsSync(r)){let e=p.readdirSync(r);for(let i of e)if(K(i)){let e=g.join(r,i,t||``);p.existsSync(e)&&p.existsSync(`${e}.complete`)&&n.push(i)}}return n}t.findAllVersions=B;function V(e,t,n,r=`master`){return c(this,void 0,void 0,function*(){let i=[],a=`https://api.github.com/repos/${e}/${t}/git/trees/${r}`,o=new _.HttpClient(`tool-cache`),s={};n&&(l.debug(`set auth`),s.authorization=n);let c=yield o.getJson(a,s);if(!c.result)return i;let u=``;for(let e of c.result.tree)if(e.path===`versions-manifest.json`){u=e.url;break}s.accept=`application/vnd.github.VERSION.raw`;let d=yield(yield o.get(u,s)).readBody();if(d){d=d.replace(/^\uFEFF/,``);try{i=JSON.parse(d)}catch{l.debug(`Invalid json`)}}return i})}t.getManifestFromRepo=V;function H(e,t,n,r=h.arch()){return c(this,void 0,void 0,function*(){return yield m._findMatch(e,t,n,r)})}t.findFromManifest=H;function U(e){return c(this,void 0,void 0,function*(){return e||=g.join(Y(),d.randomUUID()),yield u.mkdirP(e),e})}function W(e,t,n){return c(this,void 0,void 0,function*(){let r=g.join(J(),e,v.clean(t)||t,n||``);l.debug(`destination ${r}`);let i=`${r}.complete`;return yield u.rmRF(r),yield u.rmRF(i),yield u.mkdirP(r),r})}function G(e,t,n){let r=`${g.join(J(),e,v.clean(t)||t,n||``)}.complete`;p.writeFileSync(r,``),l.debug(`finished caching tool`)}function K(e){let t=v.clean(e)||``;l.debug(`isExplicit: ${t}`);let n=v.valid(t)!=null;return l.debug(`explicit? ${n}`),n}t.isExplicitVersion=K;function q(e,t){let n=``;l.debug(`evaluating ${e.length} versions`),e=e.sort((e,t)=>v.gt(e,t)?1:-1);for(let r=e.length-1;r>=0;r--){let i=e[r];if(v.satisfies(i,t)){n=i;break}}return n?l.debug(`matched: ${n}`):l.debug(`match not found`),n}t.evaluateVersions=q;function J(){let e=process.env.RUNNER_TOOL_CACHE||``;return(0,C.ok)(e,`Expected RUNNER_TOOL_CACHE to be defined`),e}function Y(){let e=process.env.RUNNER_TEMP||``;return(0,C.ok)(e,`Expected RUNNER_TEMP to be defined`),e}function X(e,t){let n=global[e];return n===void 0?t:n}function Z(e){return Array.from(new Set(e))}}))()),w=p(c()),T=p(m()),E=p(r());function D(e){let t;try{t=JSON.parse(e)}catch(e){throw e instanceof SyntaxError?Error(`Invalid auth-json format: ${e.message}`):e}if(typeof t!=`object`||!t||Array.isArray(t))throw Error(`auth-json must be a JSON object`);return t}async function O(e,t,n){let r=_.join(t,`auth.json`);await g.mkdir(t,{recursive:!0});let i=JSON.stringify(e,null,2);return await g.writeFile(r,i,{mode:384}),n.info(`Populated auth.json`,{path:r,providers:Object.keys(e).length}),r}async function k(e,t,n,r){let i=e??t,a=e==null?t.length>0?`github-token`:`none`:`app-token`;return i.length===0?(n.warning(`No GitHub token available for gh CLI`),{authenticated:!1,method:`none`,botLogin:null}):(h.env.GH_TOKEN=i,n.info(`Configured gh CLI authentication`,{method:a}),{authenticated:!0,method:a,botLogin:await A(i,n,r)})}async function A(e,t,n){try{let{stdout:r}=await n.getExecOutput(`gh`,[`api`,`/user`,`--jq`,`.login`],{env:{...h.env,GH_TOKEN:e},silent:!0}),i=r.trim();return i.length>0?(t.info(`Authenticated as`,{login:i}),i):null}catch{return t.debug(`Could not determine bot login`),null}}async function j(e,t,n,r){let i=e==null?`fro-bot[bot]`:`${e}[bot]`,a=t!=null&&e!=null?`${t}+${e}[bot]@users.noreply.github.com`:`agent@fro.bot`;await r.exec(`git`,[`config`,`--global`,`user.name`,i],void 0),await r.exec(`git`,[`config`,`--global`,`user.email`,a],void 0),n.info(`Configured git identity`,{name:i,email:a})}function M(){let e=b.platform(),t=b.arch();return{os:{darwin:`darwin`,linux:`linux`,win32:`windows`}[e]??`linux`,arch:{arm64:`aarch64`,x64:`x64`}[t]??`x64`,ext:`.zip`}}function N(e,t){return`https://github.com/oven-sh/bun/releases/download/bun-${e.startsWith(`v`)?e:`v${e}`}/${`bun-${t.os}-${t.arch}${t.ext}`}`}async function P(e,t,n,r,i=`1.2.5`){let a=M(),o=t.find(`bun`,i,a.arch);if(o.length>0)return e.info(`Bun found in cache`,{version:i,path:o}),r(o),{path:o,version:i,cached:!0};e.info(`Downloading Bun`,{version:i});let s=N(i,a);try{let o=await t.downloadTool(s);if(h.platform!==`win32`&&!await F(o,e,n))throw Error(`Downloaded Bun archive appears corrupted`);e.info(`Extracting Bun`);let c=await t.extractZip(o),l=`bun-${a.os}-${a.arch}`,u=v.join(c,l);e.info(`Caching Bun`);let d=await t.cacheDir(u,`bun`,i,a.arch);return r(d),e.info(`Bun installed`,{version:i,path:d}),{path:d,version:i,cached:!1}}catch(e){let t=e instanceof Error?e.message:String(e);throw Error(`Failed to install Bun ${i}: ${t}`)}}async function F(e,t,n){try{let{stdout:r}=await n.getExecOutput(`file`,[e],{silent:!0}),i=r.includes(`Zip archive`)||r.includes(`ZIP`);return i||t.warning(`Bun download validation failed`,{output:r.trim()}),i}catch{return t.debug(`Could not validate Bun download (file command unavailable)`),!0}}async function I(e){try{let{exitCode:t}=await e.getExecOutput(`bun`,[`--version`],{silent:!0,ignoreReturnCode:!0});return t===0}catch{return!1}}async function L(e,t={}){let{logger:n,execAdapter:r,toolCache:i,addPath:a}=e,{claude:o=`no`,chatgpt:s=`no`,gemini:c=`no`}=t;if(n.info(`Installing Oh My OpenCode plugin`,{claude:o,chatgpt:s,gemini:c}),!await I(r)){n.info(`Bun not found, installing...`);try{await P(n,i,r,a)}catch(e){let t=e instanceof Error?e.message:String(e);return n.error(`Failed to install Bun runtime`,{error:t}),{installed:!1,version:null,error:`Bun installation failed: ${t}`}}}let l=[`oh-my-opencode`,`install`,`--no-tui`,`--claude=${o}`,`--chatgpt=${s}`,`--gemini=${c}`];try{let e=``,t=await r.exec(`bunx`,l,{listeners:{stdout:t=>{e+=t.toString()},stderr:t=>{e+=t.toString()}},silent:!0});if(t!==0){let r=`oMo installation returned exit code ${t}`;return n.warning(r,{output:e.slice(0,500)}),{installed:!1,version:null,error:r}}let i=/oh-my-opencode@(\d+\.\d+\.\d+)/i.exec(e),a=i!=null&&i[1]!=null?i[1]:null;return n.info(`oMo plugin installed`,{version:a}),{installed:!0,version:a,error:null}}catch(e){let t=e instanceof Error?e.message:String(e);return n.error(`Failed to install oMo plugin`,{error:t}),{installed:!1,version:null,error:t}}}const R=`opencode`,z=`1.1.1`;function B(){let e=b.platform(),t=b.arch(),n={darwin:`darwin`,linux:`linux`,win32:`windows`},r={x64:`x64`,arm64:`arm64`},i=e===`win32`||e===`darwin`?`.zip`:`.tar.gz`;return{os:n[e]??`linux`,arch:r[t]??`x64`,ext:i}}function V(e,t){return`https://github.com/anomalyco/opencode/releases/download/${e.startsWith(`v`)?e:`v${e}`}/${`opencode-${t.os}-${t.arch}${t.ext}`}`}async function H(e,t,n,r){if(h.platform===`win32`)return!0;try{let{stdout:i}=await r.getExecOutput(`file`,[e],{silent:!0}),a=(t===`.zip`?[`Zip archive`,`ZIP`]:[`gzip`,`tar`,`compressed`]).some(e=>i.includes(e));return a||n.warning(`Download validation failed`,{output:i.trim()}),a}catch{return n.debug(`Could not validate download (file command unavailable)`),!0}}async function U(e,t,n,r,i=z){let a=B(),o=n.find(R,e,a.arch);if(o.length>0)return t.info(`OpenCode found in cache`,{version:e,path:o}),{path:o,version:e,cached:!0};try{return await W(e,a,t,n,r)}catch(n){t.warning(`Primary version install failed, trying fallback`,{requestedVersion:e,fallbackVersion:i,error:n instanceof Error?n.message:String(n)})}if(e!==i)try{let e=await W(i,a,t,n,r);return t.info(`Installed fallback version`,{version:i}),e}catch(t){throw Error(`Failed to install OpenCode (tried ${e} and ${i}): ${t instanceof Error?t.message:String(t)}`)}throw Error(`Failed to install OpenCode version ${e}`)}async function W(e,t,n,r,i){n.info(`Downloading OpenCode`,{version:e});let a=V(e,t),o=await r.downloadTool(a);if(!await H(o,t.ext,n,i))throw Error(`Downloaded archive appears corrupted`);n.info(`Extracting OpenCode`);let s=t.ext===`.zip`?await r.extractZip(o):await r.extractTar(o);n.info(`Caching OpenCode`);let c=await r.cacheDir(s,R,e,t.arch);return n.info(`OpenCode installed`,{version:e,path:c}),{path:c,version:e,cached:!1}}async function G(e){let t=await fetch(`https://api.github.com/repos/anomalyco/opencode/releases/latest`);if(!t.ok)throw Error(`Failed to fetch latest OpenCode version: ${t.statusText}`);let n=(await t.json()).tag_name.replace(/^v/,``);return e.info(`Latest OpenCode version`,{version:n}),n}function K(){return{find:C.find,downloadTool:C.downloadTool,extractTar:C.extractTar,extractZip:C.extractZip,cacheDir:C.cacheDir}}function q(){return{exec:E.exec,getExecOutput:E.getExecOutput}}function J(){return{opencodeVersion:T.getInput(`opencode-version`)||`latest`,authJson:T.getInput(`auth-json`,{required:!0}),appId:T.getInput(`app-id`)||null,privateKey:T.getInput(`private-key`)||null,opencodeConfig:T.getInput(`opencode-config`)||null}}async function Y(){let e=Date.now(),t=i({component:`setup`}),n=K(),r=q();try{let i=J(),a=T.getInput(`github-token`,{required:!0});t.info(`Starting setup`,{version:i.opencodeVersion});let o;try{o=D(i.authJson)}catch(e){return T.setFailed(`Invalid auth-json: ${e instanceof Error?e.message:String(e)}`),null}let c=i.opencodeVersion;if(c===`latest`)try{c=await G(t)}catch(e){t.warning(`Failed to get latest version, using fallback`,{error:e instanceof Error?e.message:String(e)}),c=z}let f;try{f=await U(c,t,n,r)}catch(e){return T.setFailed(`Failed to install OpenCode: ${e instanceof Error?e.message:String(e)}`),null}T.addPath(f.path),T.setOutput(`opencode-path`,f.path),T.setOutput(`opencode-version`,f.version),t.info(`OpenCode installed`,{version:f.version,cached:f.cached});let p=await L({logger:t,execAdapter:r,toolCache:n,addPath:T.addPath},{claude:`max20`,chatgpt:`no`,gemini:`no`});p.installed?t.info(`oMo installed`,{version:p.version}):T.warning(`oMo installation failed (continuing without it): ${p.error??`unknown error`}`);let m=await k(null,a,t,r);T.exportVariable(`GH_TOKEN`,a),t.info(`GitHub CLI configured`),await j(m.botLogin?.replace(/\[bot\]$/,``)??null,null,t,r),t.info(`Git identity configured`,{user:m.botLogin??`fro-bot[bot]`});let g=y(u(),`opencode`),_=await O(o,g,t);T.setOutput(`auth-json-path`,_),t.info(`auth.json populated`,{path:_});let v=h.env.GITHUB_REPOSITORY??`unknown/unknown`,b=h.env.GITHUB_REF_NAME??`main`,x=l(),S=s({agentIdentity:`github`,repo:v,ref:b,os:x}),C=d({agentIdentity:`github`,repo:v,ref:b,os:x}),E=`miss`;try{let e=await w.restoreCache([g],S,[...C]);e==null?t.info(`No cache found`):(E=`hit`,t.info(`Cache restored`,{key:e}))}catch(e){E=`corrupted`,t.warning(`Cache restore failed`,{error:e instanceof Error?e.message:String(e)})}T.setOutput(`cache-status`,E),T.setOutput(`storage-path`,g);let A=Date.now()-e,M={opencodePath:f.path,opencodeVersion:f.version,ghAuthenticated:m.authenticated,omoInstalled:p.installed,omoError:p.error,cacheStatus:E,duration:A};return t.info(`Setup complete`,{duration:A}),M}catch(e){let n=e instanceof Error?e.message:String(e);return t.error(`Setup failed`,{error:n}),T.setFailed(n),null}}await Y();export{};