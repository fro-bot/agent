import{A as e,D as t,M as n,N as r,O as i,P as a,c as o,d as s,f as c,h as l,j as u,k as d,m as f,o as p,s as m,u as h}from"./env-ZpmU2aqj.js";import g from"node:process";import*as _ from"node:fs/promises";import v from"node:fs/promises";import*as y from"node:path";import b,{join as x}from"node:path";import S from"node:os";var C=n(((e,t)=>{var n=e&&e.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),a=e&&e.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),o=e&&e.__importStar||(function(){var e=function(t){return e=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(t!=null)for(var i=e(t),o=0;o<i.length;o++)i[o]!==`default`&&n(r,t,i[o]);return a(r,t),r}})(),s=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(e,`__esModule`,{value:!0}),e._findMatch=m,e._getOsVersion=h,e._readLinuxVersionFile=g;let c=o(l()),u=i(),d=r(`os`),f=r(`child_process`),p=r(`fs`);function m(e,n,r,i){return s(this,void 0,void 0,function*(){let a=d.platform(),o,s,l;for(let o of r){let r=o.version;if((0,u.debug)(`check ${r} satisfies ${e}`),c.satisfies(r,e)&&(!n||o.stable===n)&&(l=o.files.find(e=>{(0,u.debug)(`${e.arch}===${i} && ${e.platform}===${a}`);let n=e.arch===i&&e.platform===a;if(n&&e.platform_version){let r=t.exports._getOsVersion();n=r===e.platform_version?!0:c.satisfies(r,e.platform_version)}return n}),l)){(0,u.debug)(`matched ${o.version}`),s=o;break}}return s&&l&&(o=Object.assign({},s),o.files=[l]),o})}function h(){let e=d.platform(),n=``;if(e===`darwin`)n=f.execSync(`sw_vers -productVersion`).toString();else if(e===`linux`){let e=t.exports._readLinuxVersionFile();if(e){let t=e.split(`
`);for(let e of t){let t=e.split(`=`);if(t.length===2&&(t[0].trim()===`VERSION_ID`||t[0].trim()===`DISTRIB_RELEASE`)){n=t[1].trim().replace(/^"/,``).replace(/"$/,``);break}}}}return n}function g(){let e=`/etc/lsb-release`,t=`/etc/os-release`,n=``;return p.existsSync(e)?n=p.readFileSync(e).toString():p.existsSync(t)&&(n=p.readFileSync(t).toString()),n}})),w=n((e=>{var t=e&&e.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),n=e&&e.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),r=e&&e.__importStar||(function(){var e=function(t){return e=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},e(t)};return function(r){if(r&&r.__esModule)return r;var i={};if(r!=null)for(var a=e(r),o=0;o<a.length;o++)a[o]!==`default`&&t(i,r,a[o]);return n(i,r),i}})(),a=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(e,`__esModule`,{value:!0}),e.RetryHelper=void 0;let o=r(i());e.RetryHelper=class{constructor(e,t,n){if(e<1)throw Error(`max attempts should be greater than or equal to 1`);if(this.maxAttempts=e,this.minSeconds=Math.floor(t),this.maxSeconds=Math.floor(n),this.minSeconds>this.maxSeconds)throw Error(`min seconds should be less than or equal to max seconds`)}execute(e,t){return a(this,void 0,void 0,function*(){let n=1;for(;n<this.maxAttempts;){try{return yield e()}catch(e){if(t&&!t(e))throw e;o.info(e.message)}let r=this.getSleepAmount();o.info(`Waiting ${r} seconds before trying again`),yield this.sleep(r),n++}return yield e()})}getSleepAmount(){return Math.floor(Math.random()*(this.maxSeconds-this.minSeconds+1))+this.minSeconds}sleep(e){return a(this,void 0,void 0,function*(){return new Promise(t=>setTimeout(t,e*1e3))})}}})),T=a(n((t=>{var n=t&&t.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),a=t&&t.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),o=t&&t.__importStar||(function(){var e=function(t){return e=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(t!=null)for(var i=e(t),o=0;o<i.length;o++)i[o]!==`default`&&n(r,t,i[o]);return a(r,t),r}})(),s=t&&t.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,`__esModule`,{value:!0}),t.HTTPError=void 0,t.downloadTool=O,t.extractTar=A,t.extractZip=j,t.cacheDir=P,t.find=F;let c=o(i()),f=o(e()),p=o(r(`crypto`)),m=o(r(`fs`));o(C());let h=o(r(`os`)),g=o(r(`path`)),_=o(u()),v=o(l()),y=o(r(`stream`)),b=o(r(`util`)),x=r(`assert`),S=d(),T=w();var E=class extends Error{constructor(e){super(`Unexpected HTTP response: ${e}`),this.httpStatusCode=e,Object.setPrototypeOf(this,new.target.prototype)}};t.HTTPError=E;let D=process.platform===`win32`;process.platform;function O(e,t,n,r){return s(this,void 0,void 0,function*(){t||=g.join(U(),p.randomUUID()),yield f.mkdirP(g.dirname(t)),c.debug(`Downloading ${e}`),c.debug(`Destination ${t}`);let i=W(`TEST_DOWNLOAD_TOOL_RETRY_MIN_SECONDS`,10),a=W(`TEST_DOWNLOAD_TOOL_RETRY_MAX_SECONDS`,20);return yield new T.RetryHelper(3,i,a).execute(()=>s(this,void 0,void 0,function*(){return yield k(e,t||``,n,r)}),e=>!(e instanceof E&&e.httpStatusCode&&e.httpStatusCode<500&&e.httpStatusCode!==408&&e.httpStatusCode!==429))})}function k(e,t,n,r){return s(this,void 0,void 0,function*(){if(m.existsSync(t))throw Error(`Destination file path ${t} already exists`);let i=new _.HttpClient(`actions/tool-cache`,[],{allowRetries:!1});n&&(c.debug(`set auth`),r===void 0&&(r={}),r.authorization=n);let a=yield i.get(e,r);if(a.message.statusCode!==200){let t=new E(a.message.statusCode);throw c.debug(`Failed to download from "${e}". Code(${a.message.statusCode}) Message(${a.message.statusMessage})`),t}let o=b.promisify(y.pipeline),s=W(`TEST_DOWNLOAD_TOOL_RESPONSE_MESSAGE_FACTORY`,()=>a.message)(),l=!1;try{return yield o(s,m.createWriteStream(t)),c.debug(`download complete`),l=!0,t}finally{if(!l){c.debug(`download failed`);try{yield f.rmRF(t)}catch(e){c.debug(`Failed to delete '${t}'. ${e.message}`)}}}})}function A(e,t){return s(this,arguments,void 0,function*(e,t,n=`xz`){if(!e)throw Error(`parameter 'file' is required`);t=yield L(t),c.debug(`Checking tar --version`);let r=``;yield(0,S.exec)(`tar --version`,[],{ignoreReturnCode:!0,silent:!0,listeners:{stdout:e=>r+=e.toString(),stderr:e=>r+=e.toString()}}),c.debug(r.trim());let i=r.toUpperCase().includes(`GNU TAR`),a;a=n instanceof Array?n:[n],c.isDebug()&&!n.includes(`v`)&&a.push(`-v`);let o=t,s=e;return D&&i&&(a.push(`--force-local`),o=t.replace(/\\/g,`/`),s=e.replace(/\\/g,`/`)),i&&(a.push(`--warning=no-unknown-keyword`),a.push(`--overwrite`)),a.push(`-C`,o,`-f`,s),yield(0,S.exec)(`tar`,a),t})}function j(e,t){return s(this,void 0,void 0,function*(){if(!e)throw Error(`parameter 'file' is required`);return t=yield L(t),D?yield M(e,t):yield N(e,t),t})}function M(e,t){return s(this,void 0,void 0,function*(){let n=e.replace(/'/g,`''`).replace(/"|\n|\r/g,``),r=t.replace(/'/g,`''`).replace(/"|\n|\r/g,``),i=yield f.which(`pwsh`,!1);if(i){let e=[`-NoLogo`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,[`$ErrorActionPreference = 'Stop' ;`,`try { Add-Type -AssemblyName System.IO.Compression.ZipFile } catch { } ;`,`try { [System.IO.Compression.ZipFile]::ExtractToDirectory('${n}', '${r}', $true) }`,`catch { if (($_.Exception.GetType().FullName -eq 'System.Management.Automation.MethodException') -or ($_.Exception.GetType().FullName -eq 'System.Management.Automation.RuntimeException') ){ Expand-Archive -LiteralPath '${n}' -DestinationPath '${r}' -Force } else { throw $_ } } ;`].join(` `)];c.debug(`Using pwsh at path: ${i}`),yield(0,S.exec)(`"${i}"`,e)}else{let e=[`-NoLogo`,`-Sta`,`-NoProfile`,`-NonInteractive`,`-ExecutionPolicy`,`Unrestricted`,`-Command`,[`$ErrorActionPreference = 'Stop' ;`,`try { Add-Type -AssemblyName System.IO.Compression.FileSystem } catch { } ;`,`if ((Get-Command -Name Expand-Archive -Module Microsoft.PowerShell.Archive -ErrorAction Ignore)) { Expand-Archive -LiteralPath '${n}' -DestinationPath '${r}' -Force }`,`else {[System.IO.Compression.ZipFile]::ExtractToDirectory('${n}', '${r}', $true) }`].join(` `)],t=yield f.which(`powershell`,!0);c.debug(`Using powershell at path: ${t}`),yield(0,S.exec)(`"${t}"`,e)}})}function N(e,t){return s(this,void 0,void 0,function*(){let n=yield f.which(`unzip`,!0),r=[e];c.isDebug()||r.unshift(`-q`),r.unshift(`-o`),yield(0,S.exec)(`"${n}"`,r,{cwd:t})})}function P(e,t,n,r){return s(this,void 0,void 0,function*(){if(n=v.clean(n)||n,r||=h.arch(),c.debug(`Caching tool ${t} ${n} ${r}`),c.debug(`source dir: ${e}`),!m.statSync(e).isDirectory())throw Error(`sourceDir is not a directory`);let i=yield R(t,n,r);for(let t of m.readdirSync(e)){let n=g.join(e,t);yield f.cp(n,i,{recursive:!0})}return z(t,n,r),i})}function F(e,t,n){if(!e)throw Error(`toolName parameter is required`);if(!t)throw Error(`versionSpec parameter is required`);n||=h.arch(),B(t)||(t=V(I(e,n),t));let r=``;if(t){t=v.clean(t)||``;let i=g.join(H(),e,t,n);c.debug(`checking cache: ${i}`),m.existsSync(i)&&m.existsSync(`${i}.complete`)?(c.debug(`Found tool in cache ${e} ${t} ${n}`),r=i):c.debug(`not found`)}return r}function I(e,t){let n=[];t||=h.arch();let r=g.join(H(),e);if(m.existsSync(r)){let e=m.readdirSync(r);for(let i of e)if(B(i)){let e=g.join(r,i,t||``);m.existsSync(e)&&m.existsSync(`${e}.complete`)&&n.push(i)}}return n}function L(e){return s(this,void 0,void 0,function*(){return e||=g.join(U(),p.randomUUID()),yield f.mkdirP(e),e})}function R(e,t,n){return s(this,void 0,void 0,function*(){let r=g.join(H(),e,v.clean(t)||t,n||``);c.debug(`destination ${r}`);let i=`${r}.complete`;return yield f.rmRF(r),yield f.rmRF(i),yield f.mkdirP(r),r})}function z(e,t,n){let r=`${g.join(H(),e,v.clean(t)||t,n||``)}.complete`;m.writeFileSync(r,``),c.debug(`finished caching tool`)}function B(e){let t=v.clean(e)||``;c.debug(`isExplicit: ${t}`);let n=v.valid(t)!=null;return c.debug(`explicit? ${n}`),n}function V(e,t){let n=``;c.debug(`evaluating ${e.length} versions`),e=e.sort((e,t)=>v.gt(e,t)?1:-1);for(let r=e.length-1;r>=0;r--){let i=e[r];if(v.satisfies(i,t)){n=i;break}}return n?c.debug(`matched: ${n}`):c.debug(`match not found`),n}function H(){let e=process.env.RUNNER_TOOL_CACHE||``;return(0,x.ok)(e,`Expected RUNNER_TOOL_CACHE to be defined`),e}function U(){let e=process.env.RUNNER_TEMP||``;return(0,x.ok)(e,`Expected RUNNER_TEMP to be defined`),e}function W(e,t){let n=global[e];return n===void 0?t:n}}))()),E=a(f()),D=a(t()),O=a(i()),k=a(d());function A(e){let t;try{t=JSON.parse(e)}catch(e){throw e instanceof SyntaxError?Error(`Invalid auth-json format: ${e.message}`):e}if(typeof t!=`object`||!t||Array.isArray(t))throw Error(`auth-json must be a JSON object`);return t}async function j(e,t,n){let r=y.join(t,`auth.json`);await _.mkdir(t,{recursive:!0});let i=JSON.stringify(e,null,2);return await _.writeFile(r,i,{mode:384}),n.info(`Populated auth.json`,{path:r,providers:Object.keys(e).length}),r}async function M(e,t,n,r){let i=t??n,a=t==null?n.length>0?`github-token`:`none`:`app-token`;if(i.length===0)return r.warning(`No GitHub token available`),{authenticated:!1,method:`none`,botLogin:null};g.env.GH_TOKEN=i,r.info(`Configured authentication`,{method:a});let o=null;return e!=null&&(o=await h(e,r)),{authenticated:!0,method:a,botLogin:o}}async function N(e,t,n,r){let i=e==null?`fro-bot[bot]`:`${e}[bot]`,a=t!=null&&e!=null?`${t}+${e}[bot]@users.noreply.github.com`:`agent@fro.bot`;await r.exec(`git`,[`config`,`--global`,`user.name`,i],void 0),await r.exec(`git`,[`config`,`--global`,`user.email`,a],void 0),n.info(`Configured git identity`,{name:i,email:a})}function P(){let e=S.platform(),t=S.arch();return{os:{darwin:`darwin`,linux:`linux`,win32:`windows`}[e]??`linux`,arch:{arm64:`aarch64`,x64:`x64`}[t]??`x64`,ext:`.zip`}}function F(e,t){return`https://github.com/oven-sh/bun/releases/download/bun-${e.startsWith(`v`)?e:`v${e}`}/${`bun-${t.os}-${t.arch}${t.ext}`}`}async function I(e,t,n,r,i=`1.3.5`){let a=P(),o=t.find(`bun`,i,a.arch);if(o.length>0)return e.info(`Bun found in cache`,{version:i,path:o}),r(o),await R(o),{path:o,version:i,cached:!0};e.info(`Downloading Bun`,{version:i});let s=F(i,a);try{let o=await t.downloadTool(s);if(g.platform!==`win32`&&!await z(o,e,n))throw Error(`Downloaded Bun archive appears corrupted`);e.info(`Extracting Bun`);let c=await L(await t.extractZip(o),t),l=b.dirname(c);e.info(`Caching Bun`);let u=await t.cacheDir(l,`bun`,i,a.arch);return r(u),await R(u),e.info(`Bun installed`,{version:i,path:u}),{path:u,version:i,cached:!1}}catch(e){let t=e instanceof Error?e.message:String(e);throw Error(`Failed to install Bun ${i}: ${t}`)}}async function L(e,t){for(let n of await v.readdir(e,{withFileTypes:!0})){let{name:r}=n,i=b.join(e,r);if(n.isFile()){if(r===`bun`||r===`bun.exe`)return i;if(/^bun.*\.zip/.test(r))return L(await t.extractZip(i),t)}if(r.startsWith(`bun`)&&n.isDirectory())return L(i,t)}throw Error(`Could not find executable: bun`)}async function R(e){let t=e=>g.platform===`win32`?`${e}.exe`:e,n=b.join(e,t(`bun`));try{await v.symlink(n,b.join(e,t(`bunx`)))}catch(e){if(typeof e!=`object`||e.code!==`EEXIST`)throw e}}async function z(e,t,n){try{let{stdout:r}=await n.getExecOutput(`file`,[e],{silent:!0}),i=r.includes(`Zip archive`)||r.includes(`ZIP`);return i||t.warning(`Bun download validation failed`,{output:r.trim()}),i}catch{return t.debug(`Could not validate Bun download (file command unavailable)`),!0}}async function B(e){try{let{exitCode:t}=await e.getExecOutput(`bun`,[`--version`],{silent:!0,ignoreReturnCode:!0});return t===0}catch{return!1}}async function V(e,t={}){let{logger:n,execAdapter:r,toolCache:i,addPath:a}=e,{claude:o=`no`,chatgpt:s=`no`,gemini:c=`no`}=t;if(n.info(`Installing Oh My OpenCode plugin`,{claude:o,chatgpt:s,gemini:c}),!await B(r)){n.info(`Bun not found, installing...`);try{await I(n,i,r,a)}catch(e){let t=e instanceof Error?e.message:String(e);return n.error(`Failed to install Bun runtime`,{error:t}),{installed:!1,version:null,error:`Bun installation failed: ${t}`}}}let l=[`oh-my-opencode`,`install`,`--no-tui`,`--claude=${o}`,`--chatgpt=${s}`,`--gemini=${c}`];try{let e=``,t=await r.exec(`bunx`,l,{listeners:{stdout:t=>{e+=t.toString()},stderr:t=>{e+=t.toString()}},silent:!0});if(t!==0){let r=`oMo installation returned exit code ${t}`;return n.warning(r,{output:e.slice(0,500)}),{installed:!1,version:null,error:r}}let i=/oh-my-opencode@(\d+\.\d+\.\d+)/i.exec(e),a=i!=null&&i[1]!=null?i[1]:null;return n.info(`oMo plugin installed`,{version:a}),{installed:!0,version:a,error:null}}catch(e){let t=e instanceof Error?e.message:String(e);return n.error(`Failed to install oMo plugin`,{error:t}),{installed:!1,version:null,error:t}}}const H=`opencode`,U=`1.1.1`;function W(){let e=S.platform(),t=S.arch(),n={darwin:`darwin`,linux:`linux`,win32:`windows`},r={x64:`x64`,arm64:`arm64`},i=e===`win32`||e===`darwin`?`.zip`:`.tar.gz`;return{os:n[e]??`linux`,arch:r[t]??`x64`,ext:i}}function G(e,t){return`https://github.com/anomalyco/opencode/releases/download/${e.startsWith(`v`)?e:`v${e}`}/${`opencode-${t.os}-${t.arch}${t.ext}`}`}async function K(e,t,n,r){if(g.platform===`win32`)return!0;try{let{stdout:i}=await r.getExecOutput(`file`,[e],{silent:!0}),a=(t===`.zip`?[`Zip archive`,`ZIP`]:[`gzip`,`tar`,`compressed`]).some(e=>i.includes(e));return a||n.warning(`Download validation failed`,{output:i.trim()}),a}catch{return n.debug(`Could not validate download (file command unavailable)`),!0}}async function q(e,t,n,r,i=U){let a=W(),o=n.find(H,e,a.arch);if(o.length>0)return t.info(`OpenCode found in cache`,{version:e,path:o}),{path:o,version:e,cached:!0};try{return await J(e,a,t,n,r)}catch(n){t.warning(`Primary version install failed, trying fallback`,{requestedVersion:e,fallbackVersion:i,error:n instanceof Error?n.message:String(n)})}if(e!==i)try{let e=await J(i,a,t,n,r);return t.info(`Installed fallback version`,{version:i}),e}catch(t){throw Error(`Failed to install OpenCode (tried ${e} and ${i}): ${t instanceof Error?t.message:String(t)}`)}throw Error(`Failed to install OpenCode version ${e}`)}async function J(e,t,n,r,i){n.info(`Downloading OpenCode`,{version:e});let a=G(e,t),o=await r.downloadTool(a);if(!await K(o,t.ext,n,i))throw Error(`Downloaded archive appears corrupted`);n.info(`Extracting OpenCode`);let s=t.ext===`.zip`?await r.extractZip(o):await r.extractTar(o);n.info(`Caching OpenCode`);let c=await r.cacheDir(s,H,e,t.arch);return n.info(`OpenCode installed`,{version:e,path:c}),{path:c,version:e,cached:!1}}async function Y(e){let t=await fetch(`https://api.github.com/repos/anomalyco/opencode/releases/latest`);if(!t.ok)throw Error(`Failed to fetch latest OpenCode version: ${t.statusText}`);let n=(await t.json()).tag_name.replace(/^v/,``);return e.info(`Latest OpenCode version`,{version:n}),n}function X(){return{find:T.find,downloadTool:T.downloadTool,extractTar:T.extractTar,extractZip:T.extractZip,cacheDir:T.cacheDir}}function Z(){return{exec:k.exec,getExecOutput:k.getExecOutput}}function Q(){return{opencodeVersion:O.getInput(`opencode-version`)||`latest`,authJson:O.getInput(`auth-json`,{required:!0}),appId:O.getInput(`app-id`)||null,privateKey:O.getInput(`private-key`)||null,opencodeConfig:O.getInput(`opencode-config`)||null}}async function $(){let e=Date.now(),t=o({component:`setup`}),n=X(),r=Z();try{let i=Q(),a=O.getInput(`github-token`,{required:!0});t.info(`Starting setup`,{version:i.opencodeVersion});let o;try{o=A(i.authJson)}catch(e){return O.setFailed(`Invalid auth-json: ${e instanceof Error?e.message:String(e)}`),null}let l=i.opencodeVersion;if(l===`latest`)try{l=await Y(t)}catch(e){t.warning(`Failed to get latest version, using fallback`,{error:e instanceof Error?e.message:String(e)}),l=U}let u;try{u=await q(l,t,n,r)}catch(e){return O.setFailed(`Failed to install OpenCode: ${e instanceof Error?e.message:String(e)}`),null}O.addPath(u.path),O.setOutput(`opencode-path`,u.path),O.setOutput(`opencode-version`,u.version),t.info(`OpenCode installed`,{version:u.version,cached:u.cached});let d=await V({logger:t,execAdapter:r,toolCache:n,addPath:O.addPath},{claude:`no`,chatgpt:`no`,gemini:`no`});d.installed?t.info(`oMo installed`,{version:d.version}):O.warning(`oMo installation failed (continuing without it): ${d.error??`unknown error`}`);let f=await M((0,D.getOctokit)(a),null,a,t);O.exportVariable(`GH_TOKEN`,a),t.info(`GitHub CLI configured`),await N(f.botLogin?.replace(/\[bot\]$/,``)??null,null,t,r),t.info(`Git identity configured`,{user:f.botLogin??`fro-bot[bot]`});let h=x(m(),`opencode`),_=await j(o,h,t);O.setOutput(`auth-json-path`,_),t.info(`auth.json populated`,{path:_});let v=g.env.GITHUB_REPOSITORY??`unknown/unknown`,y=g.env.GITHUB_REF_NAME??`main`,b=p(),S=s({agentIdentity:`github`,repo:v,ref:y,os:b}),C=c({agentIdentity:`github`,repo:v,ref:y,os:b}),w=`miss`;try{let e=await E.restoreCache([h],S,[...C]);e==null?t.info(`No cache found`):(w=`hit`,t.info(`Cache restored`,{key:e}))}catch(e){w=`corrupted`,t.warning(`Cache restore failed`,{error:e instanceof Error?e.message:String(e)})}O.setOutput(`cache-status`,w),O.setOutput(`storage-path`,h);let T=Date.now()-e,k={opencodePath:u.path,opencodeVersion:u.version,ghAuthenticated:f.authenticated,omoInstalled:d.installed,omoError:d.error,cacheStatus:w,duration:T};return t.info(`Setup complete`,{duration:T}),k}catch(e){let n=e instanceof Error?e.message:String(e);return t.error(`Setup failed`,{error:n}),O.setFailed(n),null}}await $();export{};